<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="" xml:lang="">
<head>
  <meta charset="utf-8" />
  <meta name="generator" content="pandoc" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes" />
  <title>Case Study - Effects of snow cover characteristics and reproduction on body mass in bighorn sheep (Ovis canadensis)</title>
  <style>
    code{white-space: pre-wrap;}
    span.smallcaps{font-variant: small-caps;}
    span.underline{text-decoration: underline;}
    div.column{display: inline-block; vertical-align: top; width: 50%;}
    div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
    ul.task-list{list-style: none;}
    pre > code.sourceCode { white-space: pre; position: relative; }
    pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
    pre > code.sourceCode > span:empty { height: 1.2em; }
    code.sourceCode > span { color: inherit; text-decoration: inherit; }
    div.sourceCode { margin: 1em 0; }
    pre.sourceCode { margin: 0; }
    @media screen {
    div.sourceCode { overflow: auto; }
    }
    @media print {
    pre > code.sourceCode { white-space: pre-wrap; }
    pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
    }
    pre.numberSource code
      { counter-reset: source-line 0; }
    pre.numberSource code > span
      { position: relative; left: -4em; counter-increment: source-line; }
    pre.numberSource code > span > a:first-child::before
      { content: counter(source-line);
        position: relative; left: -1em; text-align: right; vertical-align: baseline;
        border: none; display: inline-block;
        -webkit-touch-callout: none; -webkit-user-select: none;
        -khtml-user-select: none; -moz-user-select: none;
        -ms-user-select: none; user-select: none;
        padding: 0 4px; width: 4em;
        color: #aaaaaa;
      }
    pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
    div.sourceCode
      {   }
    @media screen {
    pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
    }
    code span.al { color: #ff0000; font-weight: bold; } /* Alert */
    code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
    code span.at { color: #7d9029; } /* Attribute */
    code span.bn { color: #40a070; } /* BaseN */
    code span.bu { } /* BuiltIn */
    code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
    code span.ch { color: #4070a0; } /* Char */
    code span.cn { color: #880000; } /* Constant */
    code span.co { color: #60a0b0; font-style: italic; } /* Comment */
    code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
    code span.do { color: #ba2121; font-style: italic; } /* Documentation */
    code span.dt { color: #902000; } /* DataType */
    code span.dv { color: #40a070; } /* DecVal */
    code span.er { color: #ff0000; font-weight: bold; } /* Error */
    code span.ex { } /* Extension */
    code span.fl { color: #40a070; } /* Float */
    code span.fu { color: #06287e; } /* Function */
    code span.im { } /* Import */
    code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
    code span.kw { color: #007020; font-weight: bold; } /* Keyword */
    code span.op { color: #666666; } /* Operator */
    code span.ot { color: #007020; } /* Other */
    code span.pp { color: #bc7a00; } /* Preprocessor */
    code span.sc { color: #4070a0; } /* SpecialChar */
    code span.ss { color: #bb6688; } /* SpecialString */
    code span.st { color: #4070a0; } /* String */
    code span.va { color: #19177c; } /* Variable */
    code span.vs { color: #4070a0; } /* VerbatimString */
    code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
  </style>
  <link rel="stylesheet" href="styles.css" />
</head>
<body>
<header id="title-block-header">
<h1 class="title">Case Study - Effects of snow cover characteristics and reproduction on body mass in bighorn sheep (<em>Ovis canadensis</em>)</h1>
</header>
<nav id="TOC" role="doc-toc">
<ul>
<li><a href="#set-up-workspace">Set up workspace</a>
<ul>
<li><a href="#load-packages">Load packages</a></li>
<li><a href="#load-data-and-models">Load data and models</a></li>
</ul></li>
<li><a href="#female-model">Female model</a>
<ul>
<li><a href="#spring-mass-snow-reproductive-status">Spring mass ~ Snow * Reproductive status</a></li>
<li><a href="#autumn-mass-spring-mass-reproductive-status">Autumn mass ~ Spring mass * Reproductive status</a></li>
<li><a href="#indirect-effect-of-snow-on-autumn-mass">Indirect effect of snow on autumn mass</a>
<ul>
<li><a href="#predictions">Predictions</a></li>
<li><a href="#plot">plot</a></li>
</ul></li>
</ul></li>
<li><a href="#lamb-model">Lamb model</a>
<ul>
<li><a href="#spring-mass-snow-reproductive-status-1">Spring mass ~ Snow * Reproductive status</a></li>
<li><a href="#autumn-mass-spring-mass-sex">Autumn mass ~ Spring mass * Sex</a></li>
<li><a href="#indirect-effect-of-snow-on-autumn-mass-1">Indirect effect of snow on autumn mass</a>
<ul>
<li><a href="#predictions-1">Predictions</a></li>
<li><a href="#plot-1">plot</a></li>
</ul></li>
</ul></li>
<li><a href="#male-model">Male model</a>
<ul>
<li><a href="#spring-mass-snow-population-density">Spring mass ~ Snow * Population density</a></li>
<li><a href="#autumn-mass-spring-mass">Autumn mass ~ Spring mass</a></li>
<li><a href="#indirect-effect-of-snow-on-autumn-mass-population-density">Indirect effect of snow on autumn mass | population density</a></li>
</ul></li>
</ul>
</nav>
<p>Here, we display the use of the visualization method for indirect effects with a real-world example of the carry-over effects of snow cover characteristics on subsequent spring and automn mass of bighorn sheep on Ram mountain (Alberta, CAN). The original article by Crémel et al. can be found at LINK. This use case is more complex than the ones presented in the original article describing the method (LINK) as there is more than one mediator involved and in some cases, the exposure interacts with a mediator and in another case, the exposure interacts with a mediator and both mediators interact with one-another. We will display how the visualization method can be used to make such complex relationships more intuitive to interpret.</p>
<p>The full DAGs for the three analyses we will be working here can be found below:</p>
<p><img src="Kallan_DAG.png" /></p>
<p>To better understand the DAGs and relationships, readers are referred to the original publication.</p>
<h1 id="set-up-workspace">Set up workspace</h1>
<h2 id="load-packages">Load packages</h2>
<div class="cell">
<div class="sourceCode" id="cb1"><pre class="sourceCode r cell-code"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true"></a><span class="kw">library</span>(tidyverse)</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true"></a><span class="kw">library</span>(brms)</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true"></a><span class="kw">library</span>(cmdstanr)</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true"></a><span class="kw">library</span>(tidybayes)</span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true"></a><span class="kw">library</span>(ggpubr)</span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true"></a><span class="kw">library</span>(marginaleffects)</span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true"></a><span class="kw">library</span>(splines)</span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true"></a><span class="kw">library</span>(patchwork)</span></code></pre></div>
</div>
<h2 id="load-data-and-models">Load data and models</h2>
<div class="cell">
<div class="sourceCode" id="cb2"><pre class="sourceCode r cell-code"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true"></a>data_all &lt;-<span class="st"> </span><span class="kw">readRDS</span>(<span class="st">&quot;mass_loss_data_all_Kallan_Cremel.rds&quot;</span>)</span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true"></a></span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true"></a><span class="co"># Female data and model</span></span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true"></a><span class="co">## data</span></span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true"></a>Data_females_uns &lt;-<span class="st"> </span>data_all<span class="op">$</span>Data_females_uns </span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true"></a></span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true"></a><span class="co">## Model</span></span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true"></a>Mass_loss_female_repro_int &lt;-<span class="st"> </span><span class="kw">readRDS</span>(<span class="st">&quot;Mass_loss_female_repro_int_uns_Kallan_Cremel.rds&quot;</span>)</span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true"></a></span>
<span id="cb2-10"><a href="#cb2-10" aria-hidden="true"></a><span class="co"># Lamb data and model</span></span>
<span id="cb2-11"><a href="#cb2-11" aria-hidden="true"></a><span class="co">## data</span></span>
<span id="cb2-12"><a href="#cb2-12" aria-hidden="true"></a>Data_lambs_uns &lt;-<span class="st"> </span>data_all<span class="op">$</span>Data_lambs_uns</span>
<span id="cb2-13"><a href="#cb2-13" aria-hidden="true"></a></span>
<span id="cb2-14"><a href="#cb2-14" aria-hidden="true"></a></span>
<span id="cb2-15"><a href="#cb2-15" aria-hidden="true"></a><span class="co">## Model</span></span>
<span id="cb2-16"><a href="#cb2-16" aria-hidden="true"></a>Mass_loss_lamb &lt;-<span class="st"> </span><span class="kw">readRDS</span>(<span class="st">&quot;Mass_loss_lamb_uns_Kallan_Cremel.rds&quot;</span>)</span>
<span id="cb2-17"><a href="#cb2-17" aria-hidden="true"></a></span>
<span id="cb2-18"><a href="#cb2-18" aria-hidden="true"></a><span class="co"># Male data and model</span></span>
<span id="cb2-19"><a href="#cb2-19" aria-hidden="true"></a><span class="co">## data</span></span>
<span id="cb2-20"><a href="#cb2-20" aria-hidden="true"></a><span class="co">### Scaled (for model)</span></span>
<span id="cb2-21"><a href="#cb2-21" aria-hidden="true"></a>Data_male_scaled &lt;-<span class="st"> </span>data_all<span class="op">$</span>Data_male_scaled</span>
<span id="cb2-22"><a href="#cb2-22" aria-hidden="true"></a><span class="co">### Unscaled (for unscaling predictions)</span></span>
<span id="cb2-23"><a href="#cb2-23" aria-hidden="true"></a>Data_males_uns &lt;-<span class="st"> </span>data_all<span class="op">$</span>Data_males_uns</span>
<span id="cb2-24"><a href="#cb2-24" aria-hidden="true"></a></span>
<span id="cb2-25"><a href="#cb2-25" aria-hidden="true"></a><span class="co">## Model</span></span>
<span id="cb2-26"><a href="#cb2-26" aria-hidden="true"></a>Mass_loss_male_pop &lt;-<span class="st"> </span><span class="kw">readRDS</span>(<span class="st">&quot;Mass_loss_male_pop_Kallan_Cremel.rds&quot;</span>)</span></code></pre></div>
</div>
<h1 id="female-model">Female model</h1>
<p>Here, we look at the following DAG: <img src="Kallan_DAG_females.png" /></p>
<p>We will focus on Snow characteristics, reproductive status, spring mass t+1, and autumn mass t+1. In the model, snow characteristics is actually three variables that each interact with Reproductive status for their respective effects on spring mass t+1. Then, Spring mass t+1 interacts with reproductive status for its effect on autumn mass t+1.</p>
<p>The three-equation model is defined in brms as such:</p>
<div class="cell">
<div class="sourceCode" id="cb3"><pre class="sourceCode r cell-code"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true"></a>f_repro &lt;-<span class="st"> </span><span class="kw">bf</span>(lead_repro <span class="op">~</span><span class="st"> </span><span class="dv">1</span> <span class="op">+</span><span class="st"> </span><span class="kw">ns</span>(Age, <span class="dv">3</span>) <span class="op">+</span><span class="st"> </span>wtd114 <span class="op">+</span><span class="st"> </span>pop_den <span class="op">+</span><span class="st"> </span>avg_snow_depth <span class="op">+</span><span class="st"> </span>days_count <span class="op">+</span><span class="st"> </span>median_density <span class="op">+</span><span class="st"> </span>(<span class="dv">1</span> <span class="op">|</span><span class="st"> </span>ID) <span class="op">+</span><span class="st"> </span>(<span class="dv">1</span> <span class="op">|</span><span class="st"> </span>Yr), </span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true"></a>              <span class="dt">family =</span> <span class="kw">bernoulli</span>(<span class="dt">link =</span> <span class="st">&quot;logit&quot;</span>))</span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true"></a></span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true"></a>f_t_int &lt;-<span class="st"> </span><span class="kw">bf</span>(next_wtd12 <span class="op">~</span><span class="st"> </span><span class="dv">1</span> <span class="op">+</span><span class="st"> </span>wtd114 <span class="op">+</span><span class="st"> </span><span class="kw">ns</span>(Age, <span class="dv">3</span>) <span class="op">+</span><span class="st"> </span>pop_den <span class="op">+</span><span class="st"> </span></span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true"></a><span class="st">              </span>lead_repro <span class="op">*</span><span class="st"> </span>avg_snow_depth <span class="op">+</span><span class="st"> </span></span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true"></a><span class="st">              </span>lead_repro <span class="op">*</span><span class="st"> </span>days_count <span class="op">+</span><span class="st"> </span></span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true"></a><span class="st">              </span>lead_repro <span class="op">*</span><span class="st"> </span>median_density <span class="op">+</span><span class="st"> </span></span>
<span id="cb3-8"><a href="#cb3-8" aria-hidden="true"></a><span class="st">              </span>(<span class="dv">1</span> <span class="op">|</span><span class="st"> </span>ID) <span class="op">+</span><span class="st"> </span>(<span class="dv">1</span> <span class="op">|</span><span class="st"> </span>Yr), </span>
<span id="cb3-9"><a href="#cb3-9" aria-hidden="true"></a>              <span class="dt">family =</span> <span class="kw">gaussian</span>())</span>
<span id="cb3-10"><a href="#cb3-10" aria-hidden="true"></a></span>
<span id="cb3-11"><a href="#cb3-11" aria-hidden="true"></a>f_t1 &lt;-<span class="st"> </span><span class="kw">bf</span>(wtd114_next <span class="op">~</span><span class="st"> </span><span class="dv">1</span> <span class="op">+</span><span class="st"> </span>lead_repro<span class="op">*</span>next_wtd12 <span class="op">+</span><span class="st"> </span><span class="kw">ns</span>(Age_next, <span class="dv">3</span>) <span class="op">+</span><span class="st"> </span>pop_den_next <span class="op">+</span><span class="st"> </span>(<span class="dv">1</span> <span class="op">|</span><span class="st"> </span>ID) <span class="op">+</span><span class="st"> </span>(<span class="dv">1</span> <span class="op">|</span><span class="st"> </span>Yr_next), </span>
<span id="cb3-12"><a href="#cb3-12" aria-hidden="true"></a>           <span class="dt">family =</span> <span class="kw">gaussian</span>())</span>
<span id="cb3-13"><a href="#cb3-13" aria-hidden="true"></a></span>
<span id="cb3-14"><a href="#cb3-14" aria-hidden="true"></a>Mass_loss_female_repro_int &lt;-<span class="st"> </span><span class="kw">brm</span>(</span>
<span id="cb3-15"><a href="#cb3-15" aria-hidden="true"></a>  f_repro <span class="op">+</span><span class="st"> </span>f_t_int <span class="op">+</span><span class="st"> </span>f_t1,</span>
<span id="cb3-16"><a href="#cb3-16" aria-hidden="true"></a>  <span class="dt">data =</span> Data_females_uns, </span>
<span id="cb3-17"><a href="#cb3-17" aria-hidden="true"></a>  <span class="kw">set_rescor</span>(<span class="ot">FALSE</span>), </span>
<span id="cb3-18"><a href="#cb3-18" aria-hidden="true"></a>  <span class="dt">cores =</span> <span class="dv">4</span>, <span class="dt">threads =</span> <span class="kw">threading</span>(<span class="dv">2</span>), <span class="dt">backend =</span> <span class="st">&quot;cmdstanr&quot;</span>,<span class="dt">warmup =</span> <span class="dv">2000</span>, <span class="dt">iter =</span> <span class="dv">6000</span>, <span class="dt">chains =</span> <span class="dv">4</span></span>
<span id="cb3-19"><a href="#cb3-19" aria-hidden="true"></a>)</span></code></pre></div>
</div>
<p>Crémel et al. plot all of the direct effects in the DAG so we will not be repeating this here. We will only focus on the interacting effect of snow variables with reproductive status on spring mass and the interacting effect of spring mass and reproductive status on autumn mass. For the demonstration, we will work only with Average snow depth as the Snow variable. See Crémel et al. for all indirect effects.</p>
<h2 id="spring-mass-snow-reproductive-status">Spring mass ~ Snow * Reproductive status</h2>
<div class="cell">
<div class="sourceCode" id="cb4"><pre class="sourceCode r cell-code"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true"></a>col_repro &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="st">&quot;Non-reproductive&quot;</span> =<span class="st"> &quot;#d95f02&quot;</span>, <span class="st">&quot;Reproductive&quot;</span> =<span class="st"> &quot;#2ca25f&quot;</span>)</span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true"></a></span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true"></a>p_smass_snow &lt;-<span class="st"> </span><span class="kw">predictions</span>(Mass_loss_female_repro_int,</span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true"></a>                           <span class="dt">newdata =</span> <span class="kw">datagrid</span>(<span class="dt">avg_snow_depth =</span> <span class="kw">seq</span>(<span class="dt">from =</span> <span class="kw">min</span>(Data_females_uns<span class="op">$</span>avg_snow_depth),</span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true"></a>                                                                    <span class="dt">to =</span> <span class="kw">max</span>(Data_females_uns<span class="op">$</span>avg_snow_depth),</span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true"></a>                                                                    <span class="dt">by =</span> <span class="dv">1</span>),</span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true"></a>                                               <span class="dt">lead_repro =</span> <span class="kw">c</span>(<span class="dv">0</span>,<span class="dv">1</span>)),</span>
<span id="cb4-8"><a href="#cb4-8" aria-hidden="true"></a>                           <span class="dt">re_formula =</span> <span class="ot">NA</span>,       <span class="co"># Population-level predictions</span></span>
<span id="cb4-9"><a href="#cb4-9" aria-hidden="true"></a>                           <span class="dt">type =</span> <span class="st">&quot;response&quot;</span>,     <span class="co"># epred</span></span>
<span id="cb4-10"><a href="#cb4-10" aria-hidden="true"></a>                           <span class="dt">resp =</span> <span class="st">&quot;nextwtd12&quot;</span>) <span class="op">|</span><span class="er">&gt;</span><span class="st"> </span><span class="co"># spring mass</span></span>
<span id="cb4-11"><a href="#cb4-11" aria-hidden="true"></a><span class="st">               </span><span class="kw">get_draws</span>(<span class="dt">shape =</span> <span class="st">&quot;rvar&quot;</span>) <span class="op">|</span><span class="er">&gt;</span><span class="st">       </span><span class="co"># convert to rvar</span></span>
<span id="cb4-12"><a href="#cb4-12" aria-hidden="true"></a><span class="st">               </span><span class="kw">mutate</span>(<span class="dt">Reproduction_status =</span> <span class="kw">factor</span>(lead_repro, </span>
<span id="cb4-13"><a href="#cb4-13" aria-hidden="true"></a>                                      <span class="dt">levels =</span> <span class="kw">c</span>(<span class="dv">0</span>, <span class="dv">1</span>), </span>
<span id="cb4-14"><a href="#cb4-14" aria-hidden="true"></a>                                      <span class="dt">labels =</span> <span class="kw">c</span>(<span class="st">&quot;Non-reproductive&quot;</span>, <span class="st">&quot;Reproductive&quot;</span>))) </span></code></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Loading required namespace: rstan</code></pre>
</div>
<div class="sourceCode" id="cb6"><pre class="sourceCode r cell-code"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true"></a>plot_smass_snow &lt;-<span class="st"> </span><span class="kw">ggplot</span>() <span class="op">+</span></span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true"></a><span class="st">  </span><span class="kw">stat_lineribbon</span>(<span class="dt">data =</span> p_smass_snow, <span class="kw">aes</span>(<span class="dt">x =</span> avg_snow_depth, <span class="dt">ydist =</span> rvar, <span class="dt">fill =</span> Reproduction_status),</span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true"></a>                  <span class="dt">.width =</span> <span class="kw">seq</span>(<span class="fl">0.5</span>, <span class="fl">0.95</span>, <span class="dt">length.out =</span> <span class="dv">20</span>), </span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true"></a>                  <span class="dt">alpha =</span> <span class="fl">0.05</span>, <span class="dt">color =</span> <span class="st">&quot;black&quot;</span>) <span class="op">+</span></span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true"></a><span class="st">  </span><span class="kw">guides</span>(<span class="dt">fill =</span> <span class="kw">guide_legend</span>(<span class="dt">override.aes =</span> <span class="kw">list</span>(<span class="dt">alpha =</span> <span class="dv">1</span>, <span class="dt">fill =</span> <span class="ot">NA</span>, <span class="dt">color =</span> col_repro))) <span class="op">+</span></span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true"></a><span class="st">  </span><span class="kw">scale_fill_manual</span>(<span class="dt">values =</span> col_repro) <span class="op">+</span></span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true"></a><span class="st">  </span><span class="kw">labs</span>(</span>
<span id="cb6-8"><a href="#cb6-8" aria-hidden="true"></a>    <span class="dt">x =</span> <span class="st">&quot;Average snow depth (cm)&quot;</span>,</span>
<span id="cb6-9"><a href="#cb6-9" aria-hidden="true"></a>    <span class="dt">y =</span> <span class="st">&quot;Spring mass (kg)&quot;</span>,</span>
<span id="cb6-10"><a href="#cb6-10" aria-hidden="true"></a>    <span class="dt">fill =</span> <span class="st">&quot;Reproduction status (t+1)&quot;</span></span>
<span id="cb6-11"><a href="#cb6-11" aria-hidden="true"></a>  ) <span class="op">+</span></span>
<span id="cb6-12"><a href="#cb6-12" aria-hidden="true"></a><span class="st">  </span><span class="kw">theme_pubr</span>() <span class="op">+</span></span>
<span id="cb6-13"><a href="#cb6-13" aria-hidden="true"></a><span class="st">  </span><span class="kw">theme</span>(<span class="dt">legend.position =</span> <span class="st">&quot;inside&quot;</span>,</span>
<span id="cb6-14"><a href="#cb6-14" aria-hidden="true"></a>        <span class="dt">legend.position.inside =</span> <span class="kw">c</span>(<span class="fl">0.2</span>, <span class="fl">0.2</span>))</span>
<span id="cb6-15"><a href="#cb6-15" aria-hidden="true"></a></span>
<span id="cb6-16"><a href="#cb6-16" aria-hidden="true"></a>plot_smass_snow</span></code></pre></div>
<div class="cell-output-display">
<p><img src="kallan_case_study_files/figure-html/unnamed-chunk-4-1.png" width="672" /></p>
</div>
</div>
<h2 id="autumn-mass-spring-mass-reproductive-status">Autumn mass ~ Spring mass * Reproductive status</h2>
<div class="cell">
<div class="sourceCode" id="cb7"><pre class="sourceCode r cell-code"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true"></a>p_amass_smass &lt;-<span class="st"> </span><span class="kw">predictions</span>(Mass_loss_female_repro_int,</span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true"></a>                           <span class="dt">newdata =</span> <span class="kw">datagrid</span>(<span class="dt">next_wtd12 =</span> <span class="kw">seq</span>(<span class="dt">from =</span> <span class="kw">min</span>(Data_females_uns<span class="op">$</span>next_wtd12),</span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true"></a>                                                                    <span class="dt">to =</span> <span class="kw">max</span>(Data_females_uns<span class="op">$</span>next_wtd12),</span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true"></a>                                                                    <span class="dt">by =</span> <span class="dv">1</span>),</span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true"></a>                                               <span class="dt">lead_repro =</span> <span class="kw">c</span>(<span class="dv">0</span>,<span class="dv">1</span>)),</span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true"></a>                           <span class="dt">re_formula =</span> <span class="ot">NA</span>,         <span class="co"># Population-level predictions</span></span>
<span id="cb7-7"><a href="#cb7-7" aria-hidden="true"></a>                           <span class="dt">type =</span> <span class="st">&quot;response&quot;</span>,       <span class="co"># epred</span></span>
<span id="cb7-8"><a href="#cb7-8" aria-hidden="true"></a>                           <span class="dt">resp =</span> <span class="st">&quot;wtd114next&quot;</span>) <span class="op">|</span><span class="er">&gt;</span><span class="st">  </span><span class="co"># autumn mass</span></span>
<span id="cb7-9"><a href="#cb7-9" aria-hidden="true"></a><span class="st">               </span><span class="kw">get_draws</span>(<span class="dt">shape =</span> <span class="st">&quot;rvar&quot;</span>) <span class="op">|</span><span class="er">&gt;</span><span class="st">         </span><span class="co"># convert to rvar</span></span>
<span id="cb7-10"><a href="#cb7-10" aria-hidden="true"></a><span class="st">               </span><span class="kw">mutate</span>(<span class="dt">Reproduction_status =</span> <span class="kw">factor</span>(lead_repro, </span>
<span id="cb7-11"><a href="#cb7-11" aria-hidden="true"></a>                                      <span class="dt">levels =</span> <span class="kw">c</span>(<span class="dv">0</span>, <span class="dv">1</span>), </span>
<span id="cb7-12"><a href="#cb7-12" aria-hidden="true"></a>                                      <span class="dt">labels =</span> <span class="kw">c</span>(<span class="st">&quot;Non-reproductive&quot;</span>, <span class="st">&quot;Reproductive&quot;</span>))) </span>
<span id="cb7-13"><a href="#cb7-13" aria-hidden="true"></a></span>
<span id="cb7-14"><a href="#cb7-14" aria-hidden="true"></a>plot_amass_smass &lt;-<span class="st"> </span><span class="kw">ggplot</span>() <span class="op">+</span></span>
<span id="cb7-15"><a href="#cb7-15" aria-hidden="true"></a><span class="st">  </span><span class="kw">stat_lineribbon</span>(<span class="dt">data =</span> p_amass_smass, <span class="kw">aes</span>(<span class="dt">x =</span> next_wtd12, <span class="dt">ydist =</span> rvar, <span class="dt">fill =</span> Reproduction_status),</span>
<span id="cb7-16"><a href="#cb7-16" aria-hidden="true"></a>                  <span class="dt">.width =</span> <span class="kw">seq</span>(<span class="fl">0.5</span>, <span class="fl">0.95</span>, <span class="dt">length.out =</span> <span class="dv">20</span>), </span>
<span id="cb7-17"><a href="#cb7-17" aria-hidden="true"></a>                  <span class="dt">alpha =</span> <span class="fl">0.05</span>, <span class="dt">color =</span> <span class="st">&quot;black&quot;</span>) <span class="op">+</span></span>
<span id="cb7-18"><a href="#cb7-18" aria-hidden="true"></a><span class="st">  </span><span class="kw">scale_fill_manual</span>(<span class="dt">values =</span> col_repro) <span class="op">+</span></span>
<span id="cb7-19"><a href="#cb7-19" aria-hidden="true"></a><span class="st">  </span><span class="kw">guides</span>(<span class="dt">fill =</span> <span class="kw">guide_legend</span>(<span class="dt">override.aes =</span> <span class="kw">list</span>(<span class="dt">alpha =</span> <span class="dv">1</span>, <span class="dt">fill =</span> <span class="ot">NA</span>, <span class="dt">color =</span> col_repro))) <span class="op">+</span></span>
<span id="cb7-20"><a href="#cb7-20" aria-hidden="true"></a><span class="st">  </span><span class="kw">labs</span>(</span>
<span id="cb7-21"><a href="#cb7-21" aria-hidden="true"></a>    <span class="dt">x =</span> <span class="st">&quot;Spring mass (kg)&quot;</span>,</span>
<span id="cb7-22"><a href="#cb7-22" aria-hidden="true"></a>    <span class="dt">y =</span> <span class="st">&quot;Autumn mass (kg)&quot;</span>,</span>
<span id="cb7-23"><a href="#cb7-23" aria-hidden="true"></a>    <span class="dt">fill =</span> <span class="st">&quot;Reproduction status (t+1)&quot;</span></span>
<span id="cb7-24"><a href="#cb7-24" aria-hidden="true"></a>  ) <span class="op">+</span></span>
<span id="cb7-25"><a href="#cb7-25" aria-hidden="true"></a><span class="st">  </span><span class="kw">theme_pubr</span>() <span class="op">+</span></span>
<span id="cb7-26"><a href="#cb7-26" aria-hidden="true"></a><span class="st">  </span><span class="kw">theme</span>(<span class="dt">legend.position =</span> <span class="st">&quot;inside&quot;</span>,</span>
<span id="cb7-27"><a href="#cb7-27" aria-hidden="true"></a>        <span class="dt">legend.position.inside =</span> <span class="kw">c</span>(<span class="fl">0.2</span>, <span class="fl">0.8</span>))</span>
<span id="cb7-28"><a href="#cb7-28" aria-hidden="true"></a></span>
<span id="cb7-29"><a href="#cb7-29" aria-hidden="true"></a>plot_amass_smass</span></code></pre></div>
<div class="cell-output-display">
<p><img src="kallan_case_study_files/figure-html/unnamed-chunk-5-1.png" width="672" /></p>
</div>
</div>
<h2 id="indirect-effect-of-snow-on-autumn-mass">Indirect effect of snow on autumn mass</h2>
<h3 id="predictions">Predictions</h3>
<p>We want to predict autumn mass from the predicted values of spring mass as a function of snow depth and reproductive status</p>
<div class="cell">
<div class="sourceCode" id="cb8"><pre class="sourceCode r cell-code"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true"></a><span class="co"># the estimate column of p_smass_snow is the median of the posterior distribution</span></span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true"></a><span class="co"># Let&#39;s simplify the prediction object to work with after</span></span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true"></a>p_smass_snow <span class="op">|</span><span class="er">&gt;</span><span class="st"> </span></span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true"></a><span class="st">  </span><span class="kw">as_tibble</span>() <span class="op">|</span><span class="er">&gt;</span><span class="st"> </span></span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true"></a><span class="st">  </span><span class="kw">select</span>(estimate, avg_snow_depth, lead_repro) <span class="op">|</span><span class="er">&gt;</span></span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true"></a><span class="st">  </span><span class="kw">rename</span>(<span class="dt">next_wtd12 =</span> estimate) -&gt;<span class="st"> </span>spring_mass_pred</span>
<span id="cb8-7"><a href="#cb8-7" aria-hidden="true"></a></span>
<span id="cb8-8"><a href="#cb8-8" aria-hidden="true"></a><span class="co"># Custom prediction grid</span></span>
<span id="cb8-9"><a href="#cb8-9" aria-hidden="true"></a><span class="kw">datagrid</span>(<span class="dt">model =</span> Mass_loss_female_repro_int,</span>
<span id="cb8-10"><a href="#cb8-10" aria-hidden="true"></a>         <span class="dt">next_wtd12 =</span> spring_mass_pred<span class="op">$</span>next_wtd12) <span class="op">|</span><span class="er">&gt;</span></span>
<span id="cb8-11"><a href="#cb8-11" aria-hidden="true"></a><span class="st">  </span><span class="co"># need to add lead_repro separately as grid_type = &quot;dataframe&quot; argument throws an error</span></span>
<span id="cb8-12"><a href="#cb8-12" aria-hidden="true"></a><span class="st">  </span><span class="kw">select</span>(<span class="op">-</span>lead_repro) <span class="op">|</span><span class="er">&gt;</span><span class="st">      </span></span>
<span id="cb8-13"><a href="#cb8-13" aria-hidden="true"></a><span class="st">  </span><span class="kw">left_join</span>(spring_mass_pred <span class="op">|</span><span class="er">&gt;</span><span class="st"> </span><span class="kw">select</span>(next_wtd12, lead_repro)) -&gt;<span class="st"> </span>f_snow_indirect_pred_grid</span>
<span id="cb8-14"><a href="#cb8-14" aria-hidden="true"></a></span>
<span id="cb8-15"><a href="#cb8-15" aria-hidden="true"></a><span class="co"># Predictions</span></span>
<span id="cb8-16"><a href="#cb8-16" aria-hidden="true"></a>p_ind_snow_smass &lt;-<span class="st"> </span><span class="kw">predictions</span>(Mass_loss_female_repro_int,</span>
<span id="cb8-17"><a href="#cb8-17" aria-hidden="true"></a>                           <span class="dt">newdata =</span> f_snow_indirect_pred_grid,</span>
<span id="cb8-18"><a href="#cb8-18" aria-hidden="true"></a>                           <span class="dt">re_formula =</span> <span class="ot">NA</span>,         <span class="co"># Population-level predictions</span></span>
<span id="cb8-19"><a href="#cb8-19" aria-hidden="true"></a>                           <span class="dt">type =</span> <span class="st">&quot;response&quot;</span>,       <span class="co"># epred</span></span>
<span id="cb8-20"><a href="#cb8-20" aria-hidden="true"></a>                           <span class="dt">resp =</span> <span class="st">&quot;wtd114next&quot;</span>) <span class="op">|</span><span class="er">&gt;</span><span class="st">  </span><span class="co"># autumn mass</span></span>
<span id="cb8-21"><a href="#cb8-21" aria-hidden="true"></a><span class="st">                    </span><span class="kw">mutate</span>(<span class="dt">Reproduction_status =</span> <span class="kw">factor</span>(lead_repro, </span>
<span id="cb8-22"><a href="#cb8-22" aria-hidden="true"></a>                                      <span class="dt">levels =</span> <span class="kw">c</span>(<span class="dv">0</span>, <span class="dv">1</span>), </span>
<span id="cb8-23"><a href="#cb8-23" aria-hidden="true"></a>                                      <span class="dt">labels =</span> <span class="kw">c</span>(<span class="st">&quot;Non-reproductive&quot;</span>, <span class="st">&quot;Reproductive&quot;</span>))) <span class="op">|</span><span class="er">&gt;</span></span>
<span id="cb8-24"><a href="#cb8-24" aria-hidden="true"></a><span class="st">              </span><span class="co"># Add snow values from spring mass prediction grid</span></span>
<span id="cb8-25"><a href="#cb8-25" aria-hidden="true"></a><span class="st">                    </span><span class="kw">select</span>(<span class="op">-</span>avg_snow_depth) <span class="op">|</span><span class="er">&gt;</span></span>
<span id="cb8-26"><a href="#cb8-26" aria-hidden="true"></a><span class="st">                    </span><span class="kw">left_join</span>(spring_mass_pred)</span></code></pre></div>
</div>
<h3 id="plot">plot</h3>
<div class="cell">
<div class="sourceCode" id="cb9"><pre class="sourceCode r cell-code"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true"></a>COLS &lt;-<span class="st"> </span><span class="kw">alpha</span>(<span class="kw">colorRampPalette</span>(<span class="kw">c</span>(<span class="st">&quot;#d0ddd6&quot;</span>,<span class="st">&quot;#47a6ddb7&quot;</span>))(<span class="dv">30</span>),<span class="fl">0.8</span>)</span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true"></a></span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true"></a>plot_amass_smass <span class="op">+</span><span class="st"> </span></span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true"></a><span class="st">  </span><span class="kw">geom_line</span>(<span class="dt">data =</span> p_ind_snow_smass, <span class="kw">aes</span>(<span class="dt">x =</span> next_wtd12, <span class="dt">y =</span> estimate, <span class="dt">color =</span> avg_snow_depth, <span class="dt">linewidth =</span> avg_snow_depth, <span class="dt">group =</span> Reproduction_status), <span class="dt">lineend =</span> <span class="st">&quot;round&quot;</span>) <span class="op">+</span></span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true"></a><span class="st">  </span><span class="kw">scale_color_gradientn</span>(<span class="dt">colours =</span> COLS, <span class="dt">name =</span> <span class="st">&quot;Avg Snow Depth&quot;</span>) <span class="op">+</span></span>
<span id="cb9-6"><a href="#cb9-6" aria-hidden="true"></a><span class="st">  </span><span class="kw">guides</span>(<span class="dt">linewidth =</span> <span class="st">&quot;none&quot;</span>) <span class="op">+</span></span>
<span id="cb9-7"><a href="#cb9-7" aria-hidden="true"></a><span class="st">  </span><span class="kw">theme</span>(<span class="dt">legend.direction =</span> <span class="st">&quot;horizontal&quot;</span>,</span>
<span id="cb9-8"><a href="#cb9-8" aria-hidden="true"></a>        <span class="dt">legend.position =</span> <span class="st">&quot;bottom&quot;</span>)</span></code></pre></div>
<div class="cell-output-display">
<p><img src="kallan_case_study_files/figure-html/unnamed-chunk-7-1.png" width="672" /></p>
</div>
</div>
<p>The indirect effect is small compared to the direct effect so let’s zoom in a little</p>
<div class="cell">
<div class="sourceCode" id="cb10"><pre class="sourceCode r cell-code"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true"></a>plot_amass_smass <span class="op">+</span><span class="st"> </span></span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true"></a><span class="st">  </span><span class="kw">geom_line</span>(<span class="dt">data =</span> p_ind_snow_smass, <span class="kw">aes</span>(<span class="dt">x =</span> next_wtd12, <span class="dt">y =</span> estimate, <span class="dt">color =</span> avg_snow_depth, <span class="dt">linewidth =</span> avg_snow_depth, <span class="dt">group =</span> Reproduction_status), <span class="dt">lineend =</span> <span class="st">&quot;round&quot;</span>) <span class="op">+</span></span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true"></a><span class="st">  </span><span class="kw">scale_color_gradientn</span>(<span class="dt">colours =</span> COLS, <span class="dt">name =</span> <span class="st">&quot;Avg Snow Depth&quot;</span>) <span class="op">+</span></span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true"></a><span class="st">  </span><span class="kw">guides</span>(<span class="dt">linewidth =</span> <span class="st">&quot;none&quot;</span>) <span class="op">+</span></span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true"></a><span class="st">  </span><span class="kw">theme</span>(<span class="dt">legend.direction =</span> <span class="st">&quot;horizontal&quot;</span>,</span>
<span id="cb10-6"><a href="#cb10-6" aria-hidden="true"></a>        <span class="dt">legend.position =</span> <span class="st">&quot;bottom&quot;</span>) <span class="op">+</span></span>
<span id="cb10-7"><a href="#cb10-7" aria-hidden="true"></a><span class="st">  </span><span class="kw">coord_cartesian</span>(<span class="dt">xlim =</span> <span class="kw">c</span>(<span class="dv">50</span>, <span class="dv">60</span>), <span class="dt">ylim =</span> <span class="kw">c</span>(<span class="dv">60</span>, <span class="dv">80</span>))</span></code></pre></div>
<div class="cell-output-display">
<p><img src="kallan_case_study_files/figure-html/unnamed-chunk-8-1.png" width="672" /></p>
</div>
</div>
<h1 id="lamb-model">Lamb model</h1>
<p>Here, we look at the following DAG: <img src="Kallan_DAG_males_lambs.png" /></p>
<p>We will focus on Snow characteristics, sex, spring mass t+1, and autumn mass t+1. In the model, snow characteristics is actually three variables that each interact with sex for their respective effects on spring mass t+1. Then, Spring mass t+1 interacts with sex for its effect on autumn mass t+1.</p>
<p>The two-equation model is defined in brms as such:</p>
<div class="cell">
<div class="sourceCode" id="cb11"><pre class="sourceCode r cell-code"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true"></a>f_lamb_t &lt;-<span class="st"> </span><span class="kw">bf</span>(next_wtd12 <span class="op">~</span><span class="st"> </span><span class="dv">1</span> <span class="op">+</span><span class="st"> </span>Sex<span class="op">*</span>(wtd114  <span class="op">+</span><span class="st"> </span>pop_den <span class="op">+</span><span class="st"> </span>avg_snow_depth <span class="op">+</span><span class="st"> </span>days_count <span class="op">+</span><span class="st"> </span>median_density) <span class="op">+</span><span class="st"> </span>(<span class="dv">1</span> <span class="op">|</span><span class="st"> </span>Yr), <span class="dt">family =</span> <span class="kw">gaussian</span>())</span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true"></a></span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true"></a>f_lamb_t1 &lt;-<span class="st"> </span><span class="kw">bf</span>(wtd114_next <span class="op">~</span><span class="st"> </span><span class="dv">1</span> <span class="op">+</span><span class="st"> </span>Sex<span class="op">*</span>(next_wtd12 <span class="op">+</span><span class="st"> </span>pop_den_next) <span class="op">+</span><span class="st"> </span>(<span class="dv">1</span> <span class="op">|</span><span class="st"> </span>Yr_next), <span class="dt">family =</span> <span class="kw">gaussian</span>())</span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true"></a> </span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true"></a>Mass_loss_lamb &lt;-<span class="st"> </span><span class="kw">brm</span>(</span>
<span id="cb11-6"><a href="#cb11-6" aria-hidden="true"></a>  f_lamb_t <span class="op">+</span><span class="st"> </span>f_lamb_t1,</span>
<span id="cb11-7"><a href="#cb11-7" aria-hidden="true"></a>  <span class="dt">data =</span> Data_lambs_uns, <span class="kw">set_rescor</span>(<span class="ot">FALSE</span>), <span class="dt">cores=</span><span class="dv">4</span>, <span class="dt">threads =</span> <span class="kw">threading</span>(<span class="dv">2</span>), <span class="dt">backend=</span><span class="st">&quot;cmdstanr&quot;</span>, <span class="dt">warmup =</span> <span class="dv">2000</span>, <span class="dt">iter =</span> <span class="dv">6000</span></span>
<span id="cb11-8"><a href="#cb11-8" aria-hidden="true"></a>) </span></code></pre></div>
</div>
<p>Crémel et al. plot all of the direct effects in the DAG so we will not be repeating this here. We will only focus on the interacting effect of snow variables with sex on spring mass and the interacting effect of spring mass and sex on autumn mass. For the demonstration, we will work only with Average snow depth as the Snow variable. See Crémel et al. for all indirect effects.</p>
<h2 id="spring-mass-snow-reproductive-status-1">Spring mass ~ Snow * Reproductive status</h2>
<div class="cell">
<div class="sourceCode" id="cb12"><pre class="sourceCode r cell-code"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true"></a>col_sex &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="st">&quot;Male&quot;</span> =<span class="st"> &quot;#d95f02&quot;</span>, <span class="st">&quot;Female&quot;</span> =<span class="st"> &quot;#2ca25f&quot;</span>)</span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true"></a></span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true"></a>p_smass_snow_lambs &lt;-<span class="st"> </span><span class="kw">predictions</span>(Mass_loss_lamb,</span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true"></a>                           <span class="dt">newdata =</span> <span class="kw">datagrid</span>(<span class="dt">avg_snow_depth =</span> <span class="kw">seq</span>(<span class="dt">from =</span> <span class="kw">min</span>(Data_lambs_uns<span class="op">$</span>avg_snow_depth),</span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true"></a>                                                                    <span class="dt">to =</span> <span class="kw">max</span>(Data_lambs_uns<span class="op">$</span>avg_snow_depth),</span>
<span id="cb12-6"><a href="#cb12-6" aria-hidden="true"></a>                                                                    <span class="dt">by =</span> <span class="dv">1</span>),</span>
<span id="cb12-7"><a href="#cb12-7" aria-hidden="true"></a>                                               <span class="dt">Sex =</span> <span class="kw">c</span>(<span class="st">&quot;Male&quot;</span>, <span class="st">&quot;Female&quot;</span>)),</span>
<span id="cb12-8"><a href="#cb12-8" aria-hidden="true"></a>                           <span class="dt">re_formula =</span> <span class="ot">NA</span>,       <span class="co"># Population-level predictions</span></span>
<span id="cb12-9"><a href="#cb12-9" aria-hidden="true"></a>                           <span class="dt">type =</span> <span class="st">&quot;response&quot;</span>,     <span class="co"># epred</span></span>
<span id="cb12-10"><a href="#cb12-10" aria-hidden="true"></a>                           <span class="dt">resp =</span> <span class="st">&quot;nextwtd12&quot;</span>) <span class="op">|</span><span class="er">&gt;</span><span class="st"> </span><span class="co"># spring mass</span></span>
<span id="cb12-11"><a href="#cb12-11" aria-hidden="true"></a><span class="st">               </span><span class="kw">get_draws</span>(<span class="dt">shape =</span> <span class="st">&quot;rvar&quot;</span>)          <span class="co"># convert to rvar</span></span>
<span id="cb12-12"><a href="#cb12-12" aria-hidden="true"></a></span>
<span id="cb12-13"><a href="#cb12-13" aria-hidden="true"></a>plot_smass_snow_lambs &lt;-<span class="st"> </span><span class="kw">ggplot</span>() <span class="op">+</span></span>
<span id="cb12-14"><a href="#cb12-14" aria-hidden="true"></a><span class="st">  </span><span class="kw">stat_lineribbon</span>(<span class="dt">data =</span> p_smass_snow_lambs, <span class="kw">aes</span>(<span class="dt">x =</span> avg_snow_depth, <span class="dt">ydist =</span> rvar, <span class="dt">fill =</span> Sex),</span>
<span id="cb12-15"><a href="#cb12-15" aria-hidden="true"></a>                  <span class="dt">.width =</span> <span class="kw">seq</span>(<span class="fl">0.5</span>, <span class="fl">0.95</span>, <span class="dt">length.out =</span> <span class="dv">20</span>), </span>
<span id="cb12-16"><a href="#cb12-16" aria-hidden="true"></a>                  <span class="dt">alpha =</span> <span class="fl">0.05</span>, <span class="dt">color =</span> <span class="st">&quot;black&quot;</span>) <span class="op">+</span></span>
<span id="cb12-17"><a href="#cb12-17" aria-hidden="true"></a><span class="st">  </span><span class="kw">guides</span>(<span class="dt">fill =</span> <span class="kw">guide_legend</span>(<span class="dt">override.aes =</span> <span class="kw">list</span>(<span class="dt">alpha =</span> <span class="dv">1</span>, <span class="dt">fill =</span> <span class="ot">NA</span>, <span class="dt">color =</span> col_sex))) <span class="op">+</span></span>
<span id="cb12-18"><a href="#cb12-18" aria-hidden="true"></a><span class="st">  </span><span class="kw">scale_fill_manual</span>(<span class="dt">values =</span> col_sex, <span class="dt">labels =</span> <span class="kw">c</span>(<span class="st">&quot;Male&quot;</span>, <span class="st">&quot;Female&quot;</span>)) <span class="op">+</span></span>
<span id="cb12-19"><a href="#cb12-19" aria-hidden="true"></a><span class="st">  </span><span class="kw">labs</span>(</span>
<span id="cb12-20"><a href="#cb12-20" aria-hidden="true"></a>    <span class="dt">x =</span> <span class="st">&quot;Average snow depth (cm)&quot;</span>,</span>
<span id="cb12-21"><a href="#cb12-21" aria-hidden="true"></a>    <span class="dt">y =</span> <span class="st">&quot;Spring mass (kg)&quot;</span>,</span>
<span id="cb12-22"><a href="#cb12-22" aria-hidden="true"></a>    <span class="dt">fill =</span> <span class="st">&quot;Sex&quot;</span></span>
<span id="cb12-23"><a href="#cb12-23" aria-hidden="true"></a>  ) <span class="op">+</span></span>
<span id="cb12-24"><a href="#cb12-24" aria-hidden="true"></a><span class="st">  </span><span class="kw">theme_pubr</span>() <span class="op">+</span></span>
<span id="cb12-25"><a href="#cb12-25" aria-hidden="true"></a><span class="st">  </span><span class="kw">theme</span>(<span class="dt">legend.position =</span> <span class="st">&quot;inside&quot;</span>,</span>
<span id="cb12-26"><a href="#cb12-26" aria-hidden="true"></a>        <span class="dt">legend.position.inside =</span> <span class="kw">c</span>(<span class="fl">0.2</span>, <span class="fl">0.2</span>))</span>
<span id="cb12-27"><a href="#cb12-27" aria-hidden="true"></a></span>
<span id="cb12-28"><a href="#cb12-28" aria-hidden="true"></a>plot_smass_snow_lambs</span></code></pre></div>
<div class="cell-output-display">
<p><img src="kallan_case_study_files/figure-html/unnamed-chunk-10-1.png" width="672" /></p>
</div>
</div>
<h2 id="autumn-mass-spring-mass-sex">Autumn mass ~ Spring mass * Sex</h2>
<div class="cell">
<div class="sourceCode" id="cb13"><pre class="sourceCode r cell-code"><code class="sourceCode r"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true"></a>p_amass_smass_lambs &lt;-<span class="st"> </span><span class="kw">predictions</span>(Mass_loss_lamb,</span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true"></a>                           <span class="dt">newdata =</span> <span class="kw">datagrid</span>(<span class="dt">next_wtd12 =</span> <span class="kw">seq</span>(<span class="dt">from =</span> <span class="kw">min</span>(Data_lambs_uns<span class="op">$</span>next_wtd12),</span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true"></a>                                                                    <span class="dt">to =</span> <span class="kw">max</span>(Data_lambs_uns<span class="op">$</span>next_wtd12),</span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true"></a>                                                                    <span class="dt">by =</span> <span class="dv">1</span>),</span>
<span id="cb13-5"><a href="#cb13-5" aria-hidden="true"></a>                                               <span class="dt">Sex =</span> <span class="kw">c</span>(<span class="st">&quot;Male&quot;</span>, <span class="st">&quot;Female&quot;</span>)),</span>
<span id="cb13-6"><a href="#cb13-6" aria-hidden="true"></a>                           <span class="dt">re_formula =</span> <span class="ot">NA</span>,         <span class="co"># Population-level predictions</span></span>
<span id="cb13-7"><a href="#cb13-7" aria-hidden="true"></a>                           <span class="dt">type =</span> <span class="st">&quot;response&quot;</span>,       <span class="co"># epred</span></span>
<span id="cb13-8"><a href="#cb13-8" aria-hidden="true"></a>                           <span class="dt">resp =</span> <span class="st">&quot;wtd114next&quot;</span>) <span class="op">|</span><span class="er">&gt;</span><span class="st">  </span><span class="co"># autumn mass</span></span>
<span id="cb13-9"><a href="#cb13-9" aria-hidden="true"></a><span class="st">               </span><span class="kw">get_draws</span>(<span class="dt">shape =</span> <span class="st">&quot;rvar&quot;</span>)            <span class="co"># convert to rvar</span></span>
<span id="cb13-10"><a href="#cb13-10" aria-hidden="true"></a></span>
<span id="cb13-11"><a href="#cb13-11" aria-hidden="true"></a>plot_amass_smass_lambs &lt;-<span class="st"> </span><span class="kw">ggplot</span>() <span class="op">+</span></span>
<span id="cb13-12"><a href="#cb13-12" aria-hidden="true"></a><span class="st">  </span><span class="kw">stat_lineribbon</span>(<span class="dt">data =</span> p_amass_smass_lambs, <span class="kw">aes</span>(<span class="dt">x =</span> next_wtd12, <span class="dt">ydist =</span> rvar, <span class="dt">fill =</span> Sex),</span>
<span id="cb13-13"><a href="#cb13-13" aria-hidden="true"></a>                  <span class="dt">.width =</span> <span class="kw">seq</span>(<span class="fl">0.5</span>, <span class="fl">0.95</span>, <span class="dt">length.out =</span> <span class="dv">20</span>), </span>
<span id="cb13-14"><a href="#cb13-14" aria-hidden="true"></a>                  <span class="dt">alpha =</span> <span class="fl">0.05</span>, <span class="dt">color =</span> <span class="st">&quot;black&quot;</span>) <span class="op">+</span></span>
<span id="cb13-15"><a href="#cb13-15" aria-hidden="true"></a><span class="st">  </span><span class="kw">scale_fill_manual</span>(<span class="dt">values =</span> col_sex, <span class="dt">labels =</span> <span class="kw">c</span>(<span class="st">&quot;Male&quot;</span>, <span class="st">&quot;Female&quot;</span>)) <span class="op">+</span></span>
<span id="cb13-16"><a href="#cb13-16" aria-hidden="true"></a><span class="st">  </span><span class="kw">guides</span>(<span class="dt">fill =</span> <span class="kw">guide_legend</span>(<span class="dt">override.aes =</span> <span class="kw">list</span>(<span class="dt">alpha =</span> <span class="dv">1</span>, <span class="dt">fill =</span> <span class="ot">NA</span>, <span class="dt">color =</span> col_sex))) <span class="op">+</span></span>
<span id="cb13-17"><a href="#cb13-17" aria-hidden="true"></a><span class="st">  </span><span class="kw">labs</span>(</span>
<span id="cb13-18"><a href="#cb13-18" aria-hidden="true"></a>    <span class="dt">x =</span> <span class="st">&quot;Spring mass (kg)&quot;</span>,</span>
<span id="cb13-19"><a href="#cb13-19" aria-hidden="true"></a>    <span class="dt">y =</span> <span class="st">&quot;Autumn mass (kg)&quot;</span>,</span>
<span id="cb13-20"><a href="#cb13-20" aria-hidden="true"></a>    <span class="dt">fill =</span> <span class="st">&quot;Sex&quot;</span></span>
<span id="cb13-21"><a href="#cb13-21" aria-hidden="true"></a>  ) <span class="op">+</span></span>
<span id="cb13-22"><a href="#cb13-22" aria-hidden="true"></a><span class="st">  </span><span class="kw">theme_pubr</span>() <span class="op">+</span></span>
<span id="cb13-23"><a href="#cb13-23" aria-hidden="true"></a><span class="st">  </span><span class="kw">theme</span>(<span class="dt">legend.position =</span> <span class="st">&quot;inside&quot;</span>,</span>
<span id="cb13-24"><a href="#cb13-24" aria-hidden="true"></a>        <span class="dt">legend.position.inside =</span> <span class="kw">c</span>(<span class="fl">0.2</span>, <span class="fl">0.8</span>))</span>
<span id="cb13-25"><a href="#cb13-25" aria-hidden="true"></a></span>
<span id="cb13-26"><a href="#cb13-26" aria-hidden="true"></a>plot_amass_smass_lambs</span></code></pre></div>
<div class="cell-output-display">
<p><img src="kallan_case_study_files/figure-html/unnamed-chunk-11-1.png" width="672" /></p>
</div>
</div>
<h2 id="indirect-effect-of-snow-on-autumn-mass-1">Indirect effect of snow on autumn mass</h2>
<h3 id="predictions-1">Predictions</h3>
<p>We want to predict autumn mass from the predicted values of spring mass as a function of snow depth and Sex</p>
<div class="cell">
<div class="sourceCode" id="cb14"><pre class="sourceCode r cell-code"><code class="sourceCode r"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true"></a><span class="co"># the estimate column of p_smass_snow is the median of the posterior distribution</span></span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true"></a><span class="co"># Let&#39;s simplify the prediction object to work with after</span></span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true"></a>p_smass_snow_lambs <span class="op">|</span><span class="er">&gt;</span><span class="st"> </span></span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true"></a><span class="st">  </span><span class="kw">as_tibble</span>() <span class="op">|</span><span class="er">&gt;</span><span class="st"> </span></span>
<span id="cb14-5"><a href="#cb14-5" aria-hidden="true"></a><span class="st">  </span><span class="kw">select</span>(estimate, avg_snow_depth, Sex) <span class="op">|</span><span class="er">&gt;</span></span>
<span id="cb14-6"><a href="#cb14-6" aria-hidden="true"></a><span class="st">  </span><span class="kw">rename</span>(<span class="dt">next_wtd12 =</span> estimate) -&gt;<span class="st"> </span>spring_mass_pred_lambs</span>
<span id="cb14-7"><a href="#cb14-7" aria-hidden="true"></a></span>
<span id="cb14-8"><a href="#cb14-8" aria-hidden="true"></a><span class="co"># Custom prediction grid</span></span>
<span id="cb14-9"><a href="#cb14-9" aria-hidden="true"></a><span class="kw">datagrid</span>(<span class="dt">model =</span> Mass_loss_lamb,</span>
<span id="cb14-10"><a href="#cb14-10" aria-hidden="true"></a>         <span class="dt">next_wtd12 =</span> spring_mass_pred_lambs<span class="op">$</span>next_wtd12) <span class="op">|</span><span class="er">&gt;</span></span>
<span id="cb14-11"><a href="#cb14-11" aria-hidden="true"></a><span class="st">  </span><span class="co"># need to add Sex separately as grid_type = &quot;dataframe&quot; argument throws an errorr</span></span>
<span id="cb14-12"><a href="#cb14-12" aria-hidden="true"></a><span class="st">  </span><span class="kw">select</span>(<span class="op">-</span>Sex) <span class="op">|</span><span class="er">&gt;</span><span class="st">      </span></span>
<span id="cb14-13"><a href="#cb14-13" aria-hidden="true"></a><span class="st">  </span><span class="kw">left_join</span>(spring_mass_pred_lambs <span class="op">|</span><span class="er">&gt;</span><span class="st"> </span><span class="kw">select</span>(next_wtd12, Sex)) -&gt;<span class="st"> </span>f_snow_indirect_pred_grid_lambs</span>
<span id="cb14-14"><a href="#cb14-14" aria-hidden="true"></a></span>
<span id="cb14-15"><a href="#cb14-15" aria-hidden="true"></a><span class="co"># Predictions</span></span>
<span id="cb14-16"><a href="#cb14-16" aria-hidden="true"></a>p_ind_snow_smass_lambs &lt;-<span class="st"> </span><span class="kw">predictions</span>(Mass_loss_lamb,</span>
<span id="cb14-17"><a href="#cb14-17" aria-hidden="true"></a>                           <span class="dt">newdata =</span> f_snow_indirect_pred_grid_lambs,</span>
<span id="cb14-18"><a href="#cb14-18" aria-hidden="true"></a>                           <span class="dt">re_formula =</span> <span class="ot">NA</span>,         <span class="co"># Population-level predictions</span></span>
<span id="cb14-19"><a href="#cb14-19" aria-hidden="true"></a>                           <span class="dt">type =</span> <span class="st">&quot;response&quot;</span>,       <span class="co"># epred</span></span>
<span id="cb14-20"><a href="#cb14-20" aria-hidden="true"></a>                           <span class="dt">resp =</span> <span class="st">&quot;wtd114next&quot;</span>) <span class="op">|</span><span class="er">&gt;</span><span class="st">  </span><span class="co"># autumn mass</span></span>
<span id="cb14-21"><a href="#cb14-21" aria-hidden="true"></a><span class="st">              </span><span class="co"># Add snow values from spring mass prediction grid</span></span>
<span id="cb14-22"><a href="#cb14-22" aria-hidden="true"></a><span class="st">                    </span><span class="kw">select</span>(<span class="op">-</span>avg_snow_depth) <span class="op">|</span><span class="er">&gt;</span></span>
<span id="cb14-23"><a href="#cb14-23" aria-hidden="true"></a><span class="st">                    </span><span class="kw">left_join</span>(spring_mass_pred_lambs)</span></code></pre></div>
</div>
<h3 id="plot-1">plot</h3>
<div class="cell">
<div class="sourceCode" id="cb15"><pre class="sourceCode r cell-code"><code class="sourceCode r"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true"></a>COLS &lt;-<span class="st"> </span><span class="kw">alpha</span>(<span class="kw">colorRampPalette</span>(<span class="kw">c</span>(<span class="st">&quot;#d0ddd6&quot;</span>,<span class="st">&quot;#47a6ddb7&quot;</span>))(<span class="dv">30</span>),<span class="fl">0.8</span>)</span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true"></a></span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true"></a>plot_amass_smass_lambs <span class="op">+</span><span class="st"> </span></span>
<span id="cb15-4"><a href="#cb15-4" aria-hidden="true"></a><span class="st">  </span><span class="kw">geom_line</span>(<span class="dt">data =</span> p_ind_snow_smass_lambs, <span class="kw">aes</span>(<span class="dt">x =</span> next_wtd12, <span class="dt">y =</span> estimate, <span class="dt">color =</span> avg_snow_depth, <span class="dt">linewidth =</span> avg_snow_depth, <span class="dt">group =</span> Sex), <span class="dt">lineend =</span> <span class="st">&quot;round&quot;</span>) <span class="op">+</span></span>
<span id="cb15-5"><a href="#cb15-5" aria-hidden="true"></a><span class="st">  </span><span class="kw">scale_color_gradientn</span>(<span class="dt">colours =</span> COLS, <span class="dt">name =</span> <span class="st">&quot;Avg Snow Depth&quot;</span>) <span class="op">+</span></span>
<span id="cb15-6"><a href="#cb15-6" aria-hidden="true"></a><span class="st">  </span><span class="kw">guides</span>(<span class="dt">linewidth =</span> <span class="st">&quot;none&quot;</span>) <span class="op">+</span></span>
<span id="cb15-7"><a href="#cb15-7" aria-hidden="true"></a><span class="st">  </span><span class="kw">theme</span>(<span class="dt">legend.direction =</span> <span class="st">&quot;horizontal&quot;</span>,</span>
<span id="cb15-8"><a href="#cb15-8" aria-hidden="true"></a>        <span class="dt">legend.position =</span> <span class="st">&quot;bottom&quot;</span>)</span></code></pre></div>
<div class="cell-output-display">
<p><img src="kallan_case_study_files/figure-html/unnamed-chunk-13-1.png" width="672" /></p>
</div>
</div>
<h1 id="male-model">Male model</h1>
<p>Here, we look at the following DAG: <img src="Kallan_DAG_males_lambs.png" /></p>
<p>We will focus on Snow characteristics, sex, spring mass t+1, and autumn mass t+1. In the model, snow characteristics is actually three variables that each interact with population density for their respective effects on spring mass t+1. However, in this case, Spring mass t+1 dopes <em>not</em> interact with population density for its effect on autumn mass t+1. There still will be an interaction present in the indirect effects but not through the mediator most immediate to the outcome.</p>
<p>The two-equation model is defined in brms as such:</p>
<div class="cell">
<div class="sourceCode" id="cb16"><pre class="sourceCode r cell-code"><code class="sourceCode r"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true"></a>f_male_t1 &lt;-<span class="st"> </span><span class="kw">bf</span>(wtd114_next <span class="op">~</span><span class="st"> </span><span class="dv">1</span> <span class="op">+</span><span class="st"> </span><span class="kw">scale</span>(next_wtd12) <span class="op">+</span><span class="st"> </span><span class="kw">ns</span>(Age_next, <span class="dv">3</span>) <span class="op">+</span><span class="st"> </span>pop_den_next <span class="op">+</span><span class="st"> </span>(<span class="dv">1</span> <span class="op">|</span><span class="st"> </span>ID) <span class="op">+</span><span class="st"> </span>(<span class="dv">1</span> <span class="op">|</span><span class="st"> </span>Yr_next), <span class="dt">family =</span> <span class="kw">gaussian</span>())</span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true"></a></span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true"></a>f_male_pop_t &lt;-<span class="st"> </span><span class="kw">bf</span>(next_wtd12 <span class="op">~</span><span class="st"> </span><span class="dv">1</span> <span class="op">+</span><span class="st"> </span>wtd114 <span class="op">+</span><span class="st"> </span><span class="kw">ns</span>(Age, <span class="dv">3</span>) <span class="op">+</span><span class="st"> </span></span>
<span id="cb16-4"><a href="#cb16-4" aria-hidden="true"></a><span class="st">                   </span>pop_den <span class="op">*</span><span class="st"> </span>avg_snow_depth <span class="op">+</span><span class="st"> </span></span>
<span id="cb16-5"><a href="#cb16-5" aria-hidden="true"></a><span class="st">                   </span>pop_den <span class="op">*</span><span class="st"> </span>days_count <span class="op">+</span><span class="st"> </span></span>
<span id="cb16-6"><a href="#cb16-6" aria-hidden="true"></a><span class="st">                   </span>pop_den <span class="op">*</span><span class="st"> </span>median_density <span class="op">+</span><span class="st"> </span></span>
<span id="cb16-7"><a href="#cb16-7" aria-hidden="true"></a><span class="st">                   </span>(<span class="dv">1</span> <span class="op">|</span><span class="st"> </span>ID) <span class="op">+</span><span class="st"> </span>(<span class="dv">1</span> <span class="op">|</span><span class="st"> </span>Yr), </span>
<span id="cb16-8"><a href="#cb16-8" aria-hidden="true"></a>                   <span class="dt">family =</span> <span class="kw">gaussian</span>())</span>
<span id="cb16-9"><a href="#cb16-9" aria-hidden="true"></a></span>
<span id="cb16-10"><a href="#cb16-10" aria-hidden="true"></a>Mass_loss_male_pop &lt;-<span class="st"> </span><span class="kw">brm</span>(</span>
<span id="cb16-11"><a href="#cb16-11" aria-hidden="true"></a>  f_male_pop_t <span class="op">+</span><span class="st"> </span>f_male_t1,</span>
<span id="cb16-12"><a href="#cb16-12" aria-hidden="true"></a>  <span class="dt">data =</span> Data_male_scaled, </span>
<span id="cb16-13"><a href="#cb16-13" aria-hidden="true"></a>  <span class="kw">set_rescor</span>(<span class="ot">FALSE</span>), </span>
<span id="cb16-14"><a href="#cb16-14" aria-hidden="true"></a>  <span class="dt">cores =</span> <span class="dv">4</span>, <span class="dt">chains =</span> <span class="dv">4</span>, <span class="dt">warmup =</span> <span class="dv">2000</span>, <span class="dt">iter =</span> <span class="dv">6000</span>, <span class="dt">threads =</span> <span class="kw">threading</span>(<span class="dv">2</span>),</span>
<span id="cb16-15"><a href="#cb16-15" aria-hidden="true"></a>  <span class="dt">backend =</span> <span class="st">&quot;cmdstanr&quot;</span></span>
<span id="cb16-16"><a href="#cb16-16" aria-hidden="true"></a>)</span></code></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Setting &#39;rescor&#39; to TRUE by default for this model</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: In the future, &#39;rescor&#39; will be set to FALSE by default for all
models. It is thus recommended to explicitely set &#39;rescor&#39; via &#39;set_rescor&#39;
instead of using the default.</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning in ns(Age, 3): shoving &#39;interior&#39; knots matching boundary knots to
inside</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning in ns(Age_next, 3): shoving &#39;interior&#39; knots matching boundary knots to
inside</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Start sampling</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>Running MCMC with 4 parallel chains, with 2 thread(s) per chain...

Chain 1 Iteration:    1 / 6000 [  0%]  (Warmup) 
Chain 2 Iteration:    1 / 6000 [  0%]  (Warmup) 
Chain 3 Iteration:    1 / 6000 [  0%]  (Warmup) 
Chain 4 Iteration:    1 / 6000 [  0%]  (Warmup) 
Chain 1 Iteration:  100 / 6000 [  1%]  (Warmup) 
Chain 2 Iteration:  100 / 6000 [  1%]  (Warmup) 
Chain 3 Iteration:  100 / 6000 [  1%]  (Warmup) 
Chain 4 Iteration:  100 / 6000 [  1%]  (Warmup) 
Chain 4 Iteration:  200 / 6000 [  3%]  (Warmup) 
Chain 1 Iteration:  200 / 6000 [  3%]  (Warmup) 
Chain 2 Iteration:  200 / 6000 [  3%]  (Warmup) 
Chain 3 Iteration:  200 / 6000 [  3%]  (Warmup) 
Chain 4 Iteration:  300 / 6000 [  5%]  (Warmup) 
Chain 2 Iteration:  300 / 6000 [  5%]  (Warmup) 
Chain 1 Iteration:  300 / 6000 [  5%]  (Warmup) 
Chain 2 Iteration:  400 / 6000 [  6%]  (Warmup) 
Chain 1 Iteration:  400 / 6000 [  6%]  (Warmup) 
Chain 3 Iteration:  300 / 6000 [  5%]  (Warmup) 
Chain 2 Iteration:  500 / 6000 [  8%]  (Warmup) 
Chain 4 Iteration:  400 / 6000 [  6%]  (Warmup) 
Chain 1 Iteration:  500 / 6000 [  8%]  (Warmup) 
Chain 3 Iteration:  400 / 6000 [  6%]  (Warmup) 
Chain 2 Iteration:  600 / 6000 [ 10%]  (Warmup) 
Chain 1 Iteration:  600 / 6000 [ 10%]  (Warmup) 
Chain 2 Iteration:  700 / 6000 [ 11%]  (Warmup) 
Chain 3 Iteration:  500 / 6000 [  8%]  (Warmup) 
Chain 4 Iteration:  500 / 6000 [  8%]  (Warmup) 
Chain 1 Iteration:  700 / 6000 [ 11%]  (Warmup) 
Chain 2 Iteration:  800 / 6000 [ 13%]  (Warmup) 
Chain 3 Iteration:  600 / 6000 [ 10%]  (Warmup) 
Chain 4 Iteration:  600 / 6000 [ 10%]  (Warmup) 
Chain 1 Iteration:  800 / 6000 [ 13%]  (Warmup) 
Chain 2 Iteration:  900 / 6000 [ 15%]  (Warmup) 
Chain 3 Iteration:  700 / 6000 [ 11%]  (Warmup) 
Chain 4 Iteration:  700 / 6000 [ 11%]  (Warmup) 
Chain 2 Iteration: 1000 / 6000 [ 16%]  (Warmup) 
Chain 1 Iteration:  900 / 6000 [ 15%]  (Warmup) 
Chain 3 Iteration:  800 / 6000 [ 13%]  (Warmup) 
Chain 4 Iteration:  800 / 6000 [ 13%]  (Warmup) 
Chain 2 Iteration: 1100 / 6000 [ 18%]  (Warmup) 
Chain 1 Iteration: 1000 / 6000 [ 16%]  (Warmup) 
Chain 3 Iteration:  900 / 6000 [ 15%]  (Warmup) 
Chain 4 Iteration:  900 / 6000 [ 15%]  (Warmup) 
Chain 2 Iteration: 1200 / 6000 [ 20%]  (Warmup) 
Chain 1 Iteration: 1100 / 6000 [ 18%]  (Warmup) 
Chain 3 Iteration: 1000 / 6000 [ 16%]  (Warmup) 
Chain 2 Iteration: 1300 / 6000 [ 21%]  (Warmup) 
Chain 4 Iteration: 1000 / 6000 [ 16%]  (Warmup) 
Chain 1 Iteration: 1200 / 6000 [ 20%]  (Warmup) 
Chain 3 Iteration: 1100 / 6000 [ 18%]  (Warmup) 
Chain 2 Iteration: 1400 / 6000 [ 23%]  (Warmup) 
Chain 4 Iteration: 1100 / 6000 [ 18%]  (Warmup) 
Chain 1 Iteration: 1300 / 6000 [ 21%]  (Warmup) 
Chain 3 Iteration: 1200 / 6000 [ 20%]  (Warmup) 
Chain 2 Iteration: 1500 / 6000 [ 25%]  (Warmup) 
Chain 4 Iteration: 1200 / 6000 [ 20%]  (Warmup) 
Chain 1 Iteration: 1400 / 6000 [ 23%]  (Warmup) 
Chain 3 Iteration: 1300 / 6000 [ 21%]  (Warmup) 
Chain 2 Iteration: 1600 / 6000 [ 26%]  (Warmup) 
Chain 4 Iteration: 1300 / 6000 [ 21%]  (Warmup) 
Chain 3 Iteration: 1400 / 6000 [ 23%]  (Warmup) 
Chain 1 Iteration: 1500 / 6000 [ 25%]  (Warmup) 
Chain 2 Iteration: 1700 / 6000 [ 28%]  (Warmup) 
Chain 4 Iteration: 1400 / 6000 [ 23%]  (Warmup) 
Chain 3 Iteration: 1500 / 6000 [ 25%]  (Warmup) 
Chain 1 Iteration: 1600 / 6000 [ 26%]  (Warmup) 
Chain 2 Iteration: 1800 / 6000 [ 30%]  (Warmup) 
Chain 4 Iteration: 1500 / 6000 [ 25%]  (Warmup) 
Chain 3 Iteration: 1600 / 6000 [ 26%]  (Warmup) 
Chain 1 Iteration: 1700 / 6000 [ 28%]  (Warmup) 
Chain 2 Iteration: 1900 / 6000 [ 31%]  (Warmup) 
Chain 4 Iteration: 1600 / 6000 [ 26%]  (Warmup) 
Chain 3 Iteration: 1700 / 6000 [ 28%]  (Warmup) 
Chain 1 Iteration: 1800 / 6000 [ 30%]  (Warmup) 
Chain 2 Iteration: 2000 / 6000 [ 33%]  (Warmup) 
Chain 2 Iteration: 2001 / 6000 [ 33%]  (Sampling) 
Chain 3 Iteration: 1800 / 6000 [ 30%]  (Warmup) 
Chain 4 Iteration: 1700 / 6000 [ 28%]  (Warmup) 
Chain 1 Iteration: 1900 / 6000 [ 31%]  (Warmup) 
Chain 3 Iteration: 1900 / 6000 [ 31%]  (Warmup) 
Chain 2 Iteration: 2100 / 6000 [ 35%]  (Sampling) 
Chain 4 Iteration: 1800 / 6000 [ 30%]  (Warmup) 
Chain 1 Iteration: 2000 / 6000 [ 33%]  (Warmup) 
Chain 1 Iteration: 2001 / 6000 [ 33%]  (Sampling) 
Chain 3 Iteration: 2000 / 6000 [ 33%]  (Warmup) 
Chain 3 Iteration: 2001 / 6000 [ 33%]  (Sampling) 
Chain 4 Iteration: 1900 / 6000 [ 31%]  (Warmup) 
Chain 2 Iteration: 2200 / 6000 [ 36%]  (Sampling) 
Chain 1 Iteration: 2100 / 6000 [ 35%]  (Sampling) 
Chain 3 Iteration: 2100 / 6000 [ 35%]  (Sampling) 
Chain 4 Iteration: 2000 / 6000 [ 33%]  (Warmup) 
Chain 4 Iteration: 2001 / 6000 [ 33%]  (Sampling) 
Chain 2 Iteration: 2300 / 6000 [ 38%]  (Sampling) 
Chain 1 Iteration: 2200 / 6000 [ 36%]  (Sampling) 
Chain 3 Iteration: 2200 / 6000 [ 36%]  (Sampling) 
Chain 4 Iteration: 2100 / 6000 [ 35%]  (Sampling) 
Chain 2 Iteration: 2400 / 6000 [ 40%]  (Sampling) 
Chain 3 Iteration: 2300 / 6000 [ 38%]  (Sampling) 
Chain 1 Iteration: 2300 / 6000 [ 38%]  (Sampling) 
Chain 2 Iteration: 2500 / 6000 [ 41%]  (Sampling) 
Chain 4 Iteration: 2200 / 6000 [ 36%]  (Sampling) 
Chain 3 Iteration: 2400 / 6000 [ 40%]  (Sampling) 
Chain 1 Iteration: 2400 / 6000 [ 40%]  (Sampling) 
Chain 2 Iteration: 2600 / 6000 [ 43%]  (Sampling) 
Chain 4 Iteration: 2300 / 6000 [ 38%]  (Sampling) 
Chain 3 Iteration: 2500 / 6000 [ 41%]  (Sampling) 
Chain 1 Iteration: 2500 / 6000 [ 41%]  (Sampling) 
Chain 2 Iteration: 2700 / 6000 [ 45%]  (Sampling) 
Chain 4 Iteration: 2400 / 6000 [ 40%]  (Sampling) 
Chain 3 Iteration: 2600 / 6000 [ 43%]  (Sampling) 
Chain 1 Iteration: 2600 / 6000 [ 43%]  (Sampling) 
Chain 2 Iteration: 2800 / 6000 [ 46%]  (Sampling) 
Chain 4 Iteration: 2500 / 6000 [ 41%]  (Sampling) 
Chain 3 Iteration: 2700 / 6000 [ 45%]  (Sampling) 
Chain 1 Iteration: 2700 / 6000 [ 45%]  (Sampling) 
Chain 2 Iteration: 2900 / 6000 [ 48%]  (Sampling) 
Chain 4 Iteration: 2600 / 6000 [ 43%]  (Sampling) 
Chain 3 Iteration: 2800 / 6000 [ 46%]  (Sampling) 
Chain 2 Iteration: 3000 / 6000 [ 50%]  (Sampling) 
Chain 1 Iteration: 2800 / 6000 [ 46%]  (Sampling) 
Chain 4 Iteration: 2700 / 6000 [ 45%]  (Sampling) 
Chain 3 Iteration: 2900 / 6000 [ 48%]  (Sampling) 
Chain 2 Iteration: 3100 / 6000 [ 51%]  (Sampling) 
Chain 1 Iteration: 2900 / 6000 [ 48%]  (Sampling) 
Chain 4 Iteration: 2800 / 6000 [ 46%]  (Sampling) 
Chain 3 Iteration: 3000 / 6000 [ 50%]  (Sampling) 
Chain 2 Iteration: 3200 / 6000 [ 53%]  (Sampling) 
Chain 1 Iteration: 3000 / 6000 [ 50%]  (Sampling) 
Chain 4 Iteration: 2900 / 6000 [ 48%]  (Sampling) 
Chain 3 Iteration: 3100 / 6000 [ 51%]  (Sampling) 
Chain 2 Iteration: 3300 / 6000 [ 55%]  (Sampling) 
Chain 1 Iteration: 3100 / 6000 [ 51%]  (Sampling) 
Chain 4 Iteration: 3000 / 6000 [ 50%]  (Sampling) 
Chain 3 Iteration: 3200 / 6000 [ 53%]  (Sampling) 
Chain 2 Iteration: 3400 / 6000 [ 56%]  (Sampling) 
Chain 1 Iteration: 3200 / 6000 [ 53%]  (Sampling) 
Chain 4 Iteration: 3100 / 6000 [ 51%]  (Sampling) 
Chain 3 Iteration: 3300 / 6000 [ 55%]  (Sampling) 
Chain 2 Iteration: 3500 / 6000 [ 58%]  (Sampling) 
Chain 1 Iteration: 3300 / 6000 [ 55%]  (Sampling) 
Chain 4 Iteration: 3200 / 6000 [ 53%]  (Sampling) 
Chain 3 Iteration: 3400 / 6000 [ 56%]  (Sampling) 
Chain 2 Iteration: 3600 / 6000 [ 60%]  (Sampling) 
Chain 4 Iteration: 3300 / 6000 [ 55%]  (Sampling) 
Chain 1 Iteration: 3400 / 6000 [ 56%]  (Sampling) 
Chain 2 Iteration: 3700 / 6000 [ 61%]  (Sampling) 
Chain 3 Iteration: 3500 / 6000 [ 58%]  (Sampling) 
Chain 4 Iteration: 3400 / 6000 [ 56%]  (Sampling) 
Chain 1 Iteration: 3500 / 6000 [ 58%]  (Sampling) 
Chain 2 Iteration: 3800 / 6000 [ 63%]  (Sampling) 
Chain 3 Iteration: 3600 / 6000 [ 60%]  (Sampling) 
Chain 4 Iteration: 3500 / 6000 [ 58%]  (Sampling) 
Chain 1 Iteration: 3600 / 6000 [ 60%]  (Sampling) 
Chain 2 Iteration: 3900 / 6000 [ 65%]  (Sampling) 
Chain 3 Iteration: 3700 / 6000 [ 61%]  (Sampling) 
Chain 4 Iteration: 3600 / 6000 [ 60%]  (Sampling) 
Chain 1 Iteration: 3700 / 6000 [ 61%]  (Sampling) 
Chain 2 Iteration: 4000 / 6000 [ 66%]  (Sampling) 
Chain 3 Iteration: 3800 / 6000 [ 63%]  (Sampling) 
Chain 4 Iteration: 3700 / 6000 [ 61%]  (Sampling) 
Chain 1 Iteration: 3800 / 6000 [ 63%]  (Sampling) 
Chain 2 Iteration: 4100 / 6000 [ 68%]  (Sampling) 
Chain 3 Iteration: 3900 / 6000 [ 65%]  (Sampling) 
Chain 4 Iteration: 3800 / 6000 [ 63%]  (Sampling) 
Chain 1 Iteration: 3900 / 6000 [ 65%]  (Sampling) 
Chain 2 Iteration: 4200 / 6000 [ 70%]  (Sampling) 
Chain 3 Iteration: 4000 / 6000 [ 66%]  (Sampling) 
Chain 4 Iteration: 3900 / 6000 [ 65%]  (Sampling) 
Chain 1 Iteration: 4000 / 6000 [ 66%]  (Sampling) 
Chain 2 Iteration: 4300 / 6000 [ 71%]  (Sampling) 
Chain 4 Iteration: 4000 / 6000 [ 66%]  (Sampling) 
Chain 3 Iteration: 4100 / 6000 [ 68%]  (Sampling) 
Chain 1 Iteration: 4100 / 6000 [ 68%]  (Sampling) 
Chain 2 Iteration: 4400 / 6000 [ 73%]  (Sampling) 
Chain 4 Iteration: 4100 / 6000 [ 68%]  (Sampling) 
Chain 3 Iteration: 4200 / 6000 [ 70%]  (Sampling) 
Chain 1 Iteration: 4200 / 6000 [ 70%]  (Sampling) 
Chain 2 Iteration: 4500 / 6000 [ 75%]  (Sampling) 
Chain 3 Iteration: 4300 / 6000 [ 71%]  (Sampling) 
Chain 4 Iteration: 4200 / 6000 [ 70%]  (Sampling) 
Chain 2 Iteration: 4600 / 6000 [ 76%]  (Sampling) 
Chain 1 Iteration: 4300 / 6000 [ 71%]  (Sampling) 
Chain 3 Iteration: 4400 / 6000 [ 73%]  (Sampling) 
Chain 4 Iteration: 4300 / 6000 [ 71%]  (Sampling) 
Chain 2 Iteration: 4700 / 6000 [ 78%]  (Sampling) 
Chain 1 Iteration: 4400 / 6000 [ 73%]  (Sampling) 
Chain 3 Iteration: 4500 / 6000 [ 75%]  (Sampling) 
Chain 4 Iteration: 4400 / 6000 [ 73%]  (Sampling) 
Chain 2 Iteration: 4800 / 6000 [ 80%]  (Sampling) 
Chain 1 Iteration: 4500 / 6000 [ 75%]  (Sampling) 
Chain 3 Iteration: 4600 / 6000 [ 76%]  (Sampling) 
Chain 4 Iteration: 4500 / 6000 [ 75%]  (Sampling) 
Chain 2 Iteration: 4900 / 6000 [ 81%]  (Sampling) 
Chain 1 Iteration: 4600 / 6000 [ 76%]  (Sampling) 
Chain 3 Iteration: 4700 / 6000 [ 78%]  (Sampling) 
Chain 4 Iteration: 4600 / 6000 [ 76%]  (Sampling) 
Chain 2 Iteration: 5000 / 6000 [ 83%]  (Sampling) 
Chain 3 Iteration: 4800 / 6000 [ 80%]  (Sampling) 
Chain 1 Iteration: 4700 / 6000 [ 78%]  (Sampling) 
Chain 4 Iteration: 4700 / 6000 [ 78%]  (Sampling) 
Chain 2 Iteration: 5100 / 6000 [ 85%]  (Sampling) 
Chain 3 Iteration: 4900 / 6000 [ 81%]  (Sampling) 
Chain 1 Iteration: 4800 / 6000 [ 80%]  (Sampling) 
Chain 4 Iteration: 4800 / 6000 [ 80%]  (Sampling) 
Chain 2 Iteration: 5200 / 6000 [ 86%]  (Sampling) 
Chain 3 Iteration: 5000 / 6000 [ 83%]  (Sampling) 
Chain 1 Iteration: 4900 / 6000 [ 81%]  (Sampling) 
Chain 4 Iteration: 4900 / 6000 [ 81%]  (Sampling) 
Chain 2 Iteration: 5300 / 6000 [ 88%]  (Sampling) 
Chain 3 Iteration: 5100 / 6000 [ 85%]  (Sampling) 
Chain 1 Iteration: 5000 / 6000 [ 83%]  (Sampling) 
Chain 2 Iteration: 5400 / 6000 [ 90%]  (Sampling) 
Chain 4 Iteration: 5000 / 6000 [ 83%]  (Sampling) 
Chain 3 Iteration: 5200 / 6000 [ 86%]  (Sampling) 
Chain 1 Iteration: 5100 / 6000 [ 85%]  (Sampling) 
Chain 2 Iteration: 5500 / 6000 [ 91%]  (Sampling) 
Chain 4 Iteration: 5100 / 6000 [ 85%]  (Sampling) 
Chain 3 Iteration: 5300 / 6000 [ 88%]  (Sampling) 
Chain 1 Iteration: 5200 / 6000 [ 86%]  (Sampling) 
Chain 2 Iteration: 5600 / 6000 [ 93%]  (Sampling) 
Chain 3 Iteration: 5400 / 6000 [ 90%]  (Sampling) 
Chain 4 Iteration: 5200 / 6000 [ 86%]  (Sampling) 
Chain 1 Iteration: 5300 / 6000 [ 88%]  (Sampling) 
Chain 2 Iteration: 5700 / 6000 [ 95%]  (Sampling) 
Chain 3 Iteration: 5500 / 6000 [ 91%]  (Sampling) 
Chain 4 Iteration: 5300 / 6000 [ 88%]  (Sampling) 
Chain 1 Iteration: 5400 / 6000 [ 90%]  (Sampling) 
Chain 2 Iteration: 5800 / 6000 [ 96%]  (Sampling) 
Chain 3 Iteration: 5600 / 6000 [ 93%]  (Sampling) 
Chain 4 Iteration: 5400 / 6000 [ 90%]  (Sampling) 
Chain 1 Iteration: 5500 / 6000 [ 91%]  (Sampling) 
Chain 2 Iteration: 5900 / 6000 [ 98%]  (Sampling) 
Chain 3 Iteration: 5700 / 6000 [ 95%]  (Sampling) 
Chain 4 Iteration: 5500 / 6000 [ 91%]  (Sampling) 
Chain 1 Iteration: 5600 / 6000 [ 93%]  (Sampling) 
Chain 2 Iteration: 6000 / 6000 [100%]  (Sampling) 
Chain 2 finished in 116.5 seconds.
Chain 3 Iteration: 5800 / 6000 [ 96%]  (Sampling) 
Chain 4 Iteration: 5600 / 6000 [ 93%]  (Sampling) 
Chain 1 Iteration: 5700 / 6000 [ 95%]  (Sampling) 
Chain 3 Iteration: 5900 / 6000 [ 98%]  (Sampling) 
Chain 4 Iteration: 5700 / 6000 [ 95%]  (Sampling) 
Chain 1 Iteration: 5800 / 6000 [ 96%]  (Sampling) 
Chain 3 Iteration: 6000 / 6000 [100%]  (Sampling) 
Chain 3 finished in 119.6 seconds.
Chain 4 Iteration: 5800 / 6000 [ 96%]  (Sampling) 
Chain 1 Iteration: 5900 / 6000 [ 98%]  (Sampling) 
Chain 4 Iteration: 5900 / 6000 [ 98%]  (Sampling) 
Chain 1 Iteration: 6000 / 6000 [100%]  (Sampling) 
Chain 1 finished in 122.1 seconds.
Chain 4 Iteration: 6000 / 6000 [100%]  (Sampling) 
Chain 4 finished in 122.6 seconds.

All 4 chains finished successfully.
Mean chain execution time: 120.2 seconds.
Total execution time: 122.9 seconds.</code></pre>
</div>
</div>
<p>The added particularity with this specific example is that the predictors are scaled so we will be unscaling and re-scaling throughout.</p>
<h2 id="spring-mass-snow-population-density">Spring mass ~ Snow * Population density</h2>
<div class="cell">
<div class="sourceCode" id="cb23"><pre class="sourceCode r cell-code"><code class="sourceCode r"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true"></a>p_smass_snow_males &lt;-<span class="st"> </span><span class="kw">predictions</span>(Mass_loss_male_pop,</span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true"></a>                           <span class="dt">newdata =</span> <span class="kw">datagrid</span>(<span class="dt">median_density =</span> <span class="kw">seq</span>(<span class="dt">from =</span> <span class="kw">min</span>(Data_male_scaled<span class="op">$</span>median_density),</span>
<span id="cb23-3"><a href="#cb23-3" aria-hidden="true"></a>                                                                    <span class="dt">to =</span> <span class="kw">max</span>(Data_male_scaled<span class="op">$</span>median_density),</span>
<span id="cb23-4"><a href="#cb23-4" aria-hidden="true"></a>                                                                    <span class="dt">by =</span> <span class="fl">0.1</span>),</span>
<span id="cb23-5"><a href="#cb23-5" aria-hidden="true"></a>                                               <span class="dt">pop_den =</span> <span class="kw">c</span>(<span class="op">-</span><span class="dv">1</span>, <span class="dv">0</span>, <span class="dv">1</span>)),  <span class="co"># -1 SD, average, +1 SD</span></span>
<span id="cb23-6"><a href="#cb23-6" aria-hidden="true"></a>                           <span class="dt">re_formula =</span> <span class="ot">NA</span>,       <span class="co"># Population-level predictions</span></span>
<span id="cb23-7"><a href="#cb23-7" aria-hidden="true"></a>                           <span class="dt">type =</span> <span class="st">&quot;response&quot;</span>,     <span class="co"># epred</span></span>
<span id="cb23-8"><a href="#cb23-8" aria-hidden="true"></a>                           <span class="dt">resp =</span> <span class="st">&quot;nextwtd12&quot;</span>) <span class="op">|</span><span class="er">&gt;</span><span class="st"> </span><span class="co"># spring mass</span></span>
<span id="cb23-9"><a href="#cb23-9" aria-hidden="true"></a><span class="st">               </span><span class="kw">get_draws</span>(<span class="dt">shape =</span> <span class="st">&quot;rvar&quot;</span>)          <span class="co"># convert to rvar</span></span>
<span id="cb23-10"><a href="#cb23-10" aria-hidden="true"></a></span>
<span id="cb23-11"><a href="#cb23-11" aria-hidden="true"></a><span class="co"># average and sd of raw data to unscale predictors</span></span>
<span id="cb23-12"><a href="#cb23-12" aria-hidden="true"></a>sd_den &lt;-<span class="st"> </span><span class="kw">sd</span>(Data_males_uns<span class="op">$</span>median_density)</span>
<span id="cb23-13"><a href="#cb23-13" aria-hidden="true"></a>m_den  &lt;-<span class="st"> </span><span class="kw">mean</span>(Data_males_uns<span class="op">$</span>median_density)</span>
<span id="cb23-14"><a href="#cb23-14" aria-hidden="true"></a>sd_pop &lt;-<span class="st"> </span><span class="kw">sd</span>(Data_males_uns<span class="op">$</span>pop_den)</span>
<span id="cb23-15"><a href="#cb23-15" aria-hidden="true"></a>m_pop  &lt;-<span class="st"> </span><span class="kw">mean</span>(Data_males_uns<span class="op">$</span>pop_den)</span>
<span id="cb23-16"><a href="#cb23-16" aria-hidden="true"></a></span>
<span id="cb23-17"><a href="#cb23-17" aria-hidden="true"></a><span class="co"># unscale</span></span>
<span id="cb23-18"><a href="#cb23-18" aria-hidden="true"></a>p_smass_snow_males &lt;-<span class="st"> </span>p_smass_snow_males <span class="op">|</span><span class="er">&gt;</span></span>
<span id="cb23-19"><a href="#cb23-19" aria-hidden="true"></a><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">median_density_uns =</span> median_density <span class="op">*</span><span class="st"> </span>sd_den <span class="op">+</span><span class="st"> </span>m_den,</span>
<span id="cb23-20"><a href="#cb23-20" aria-hidden="true"></a>         <span class="dt">pop_den_uns =</span> pop_den <span class="op">*</span><span class="st"> </span>sd_pop <span class="op">+</span><span class="st"> </span>m_pop) <span class="op">|</span><span class="er">&gt;</span></span>
<span id="cb23-21"><a href="#cb23-21" aria-hidden="true"></a><span class="st">  </span><span class="co"># add labels for plot</span></span>
<span id="cb23-22"><a href="#cb23-22" aria-hidden="true"></a><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">Pop_Density_Label =</span> <span class="kw">factor</span>(</span>
<span id="cb23-23"><a href="#cb23-23" aria-hidden="true"></a>      <span class="kw">paste0</span>(<span class="kw">round</span>(pop_den_uns, <span class="dv">0</span>)), </span>
<span id="cb23-24"><a href="#cb23-24" aria-hidden="true"></a>      <span class="dt">levels =</span> <span class="kw">unique</span>(<span class="kw">paste0</span>(<span class="kw">round</span>(pop_den_uns, <span class="dv">0</span>))) </span>
<span id="cb23-25"><a href="#cb23-25" aria-hidden="true"></a>    )</span>
<span id="cb23-26"><a href="#cb23-26" aria-hidden="true"></a>  )</span>
<span id="cb23-27"><a href="#cb23-27" aria-hidden="true"></a></span>
<span id="cb23-28"><a href="#cb23-28" aria-hidden="true"></a></span>
<span id="cb23-29"><a href="#cb23-29" aria-hidden="true"></a>plot_smass_snow_males &lt;-<span class="st"> </span><span class="kw">ggplot</span>() <span class="op">+</span></span>
<span id="cb23-30"><a href="#cb23-30" aria-hidden="true"></a><span class="st">  </span><span class="kw">stat_lineribbon</span>(<span class="dt">data =</span> p_smass_snow_males, <span class="kw">aes</span>(<span class="dt">x =</span> median_density_uns, <span class="dt">ydist =</span> rvar, <span class="dt">fill =</span> Pop_Density_Label),</span>
<span id="cb23-31"><a href="#cb23-31" aria-hidden="true"></a>                  <span class="dt">.width =</span> <span class="kw">seq</span>(<span class="fl">0.5</span>, <span class="fl">0.95</span>, <span class="dt">length.out =</span> <span class="dv">20</span>), </span>
<span id="cb23-32"><a href="#cb23-32" aria-hidden="true"></a>                  <span class="dt">alpha =</span> <span class="fl">0.05</span>, <span class="dt">color =</span> <span class="st">&quot;black&quot;</span>) <span class="op">+</span></span>
<span id="cb23-33"><a href="#cb23-33" aria-hidden="true"></a><span class="st">  </span><span class="kw">guides</span>(<span class="dt">fill =</span> <span class="kw">guide_legend</span>(<span class="dt">override.aes =</span> <span class="kw">list</span>(<span class="dt">alpha =</span> <span class="dv">1</span>, <span class="dt">fill =</span> <span class="ot">NA</span>, <span class="dt">color =</span> <span class="kw">c</span>(<span class="st">&quot;#1b9e77&quot;</span>, <span class="st">&quot;#d95f02&quot;</span>, <span class="st">&quot;#7570b3&quot;</span>)))) <span class="op">+</span></span>
<span id="cb23-34"><a href="#cb23-34" aria-hidden="true"></a><span class="st">  </span><span class="kw">scale_fill_manual</span>(<span class="dt">values =</span> <span class="kw">c</span>(<span class="st">&quot;#1b9e77&quot;</span>, <span class="st">&quot;#d95f02&quot;</span>, <span class="st">&quot;#7570b3&quot;</span>)) <span class="op">+</span></span>
<span id="cb23-35"><a href="#cb23-35" aria-hidden="true"></a><span class="st">  </span><span class="kw">labs</span>(</span>
<span id="cb23-36"><a href="#cb23-36" aria-hidden="true"></a>    <span class="dt">x =</span> <span class="kw">expression</span>(<span class="st">&quot;Median snow density &quot;</span> (kg<span class="op">/</span>m<span class="op">^</span><span class="dv">3</span>)), </span>
<span id="cb23-37"><a href="#cb23-37" aria-hidden="true"></a>    <span class="dt">y =</span> <span class="st">&quot;Spring mass (kg)&quot;</span>,</span>
<span id="cb23-38"><a href="#cb23-38" aria-hidden="true"></a>    <span class="dt">fill  =</span> <span class="st">&quot;Population density&quot;</span> <span class="op">~</span><span class="st"> </span>(ind),</span>
<span id="cb23-39"><a href="#cb23-39" aria-hidden="true"></a>  )  <span class="op">+</span></span>
<span id="cb23-40"><a href="#cb23-40" aria-hidden="true"></a><span class="st">  </span><span class="kw">theme_pubr</span>() <span class="op">+</span></span>
<span id="cb23-41"><a href="#cb23-41" aria-hidden="true"></a><span class="st">  </span><span class="kw">theme</span>(<span class="dt">legend.position =</span> <span class="st">&quot;inside&quot;</span>,</span>
<span id="cb23-42"><a href="#cb23-42" aria-hidden="true"></a>        <span class="dt">legend.position.inside =</span> <span class="kw">c</span>(<span class="fl">0.3</span>, <span class="fl">0.7</span>))</span>
<span id="cb23-43"><a href="#cb23-43" aria-hidden="true"></a></span>
<span id="cb23-44"><a href="#cb23-44" aria-hidden="true"></a>plot_smass_snow_males</span></code></pre></div>
<div class="cell-output-display">
<p><img src="kallan_case_study_files/figure-html/unnamed-chunk-15-1.png" width="672" /></p>
</div>
</div>
<h2 id="autumn-mass-spring-mass">Autumn mass ~ Spring mass</h2>
<p>There is a little particularity here. To make the SEM work in brms, Kallan scaled spring mass (next_wtd12) in the model formula rather than in the dataset. We don`t need to scale or unscale spring mass for the predictions.</p>
<div class="cell">
<div class="sourceCode" id="cb24"><pre class="sourceCode r cell-code"><code class="sourceCode r"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true"></a>p_amass_smass_males &lt;-<span class="st"> </span><span class="kw">predictions</span>(Mass_loss_male_pop,</span>
<span id="cb24-2"><a href="#cb24-2" aria-hidden="true"></a>                           <span class="dt">newdata =</span> <span class="kw">datagrid</span>(<span class="dt">next_wtd12 =</span> <span class="kw">seq</span>(<span class="dt">from =</span> <span class="kw">min</span>(Data_male_scaled<span class="op">$</span>next_wtd12),</span>
<span id="cb24-3"><a href="#cb24-3" aria-hidden="true"></a>                                                                    <span class="dt">to =</span> <span class="kw">max</span>(Data_male_scaled<span class="op">$</span>next_wtd12),</span>
<span id="cb24-4"><a href="#cb24-4" aria-hidden="true"></a>                                                                    <span class="dt">by =</span> <span class="dv">1</span>)),</span>
<span id="cb24-5"><a href="#cb24-5" aria-hidden="true"></a>                           <span class="dt">re_formula =</span> <span class="ot">NA</span>,         <span class="co"># Population-level predictions</span></span>
<span id="cb24-6"><a href="#cb24-6" aria-hidden="true"></a>                           <span class="dt">type =</span> <span class="st">&quot;response&quot;</span>,       <span class="co"># epred</span></span>
<span id="cb24-7"><a href="#cb24-7" aria-hidden="true"></a>                           <span class="dt">resp =</span> <span class="st">&quot;wtd114next&quot;</span>) <span class="op">|</span><span class="er">&gt;</span><span class="st">  </span><span class="co"># autumn mass</span></span>
<span id="cb24-8"><a href="#cb24-8" aria-hidden="true"></a><span class="st">               </span><span class="kw">get_draws</span>(<span class="dt">shape =</span> <span class="st">&quot;rvar&quot;</span>)            <span class="co"># convert to rvar</span></span>
<span id="cb24-9"><a href="#cb24-9" aria-hidden="true"></a></span>
<span id="cb24-10"><a href="#cb24-10" aria-hidden="true"></a>plot_amass_smass_males &lt;-<span class="st"> </span><span class="kw">ggplot</span>() <span class="op">+</span></span>
<span id="cb24-11"><a href="#cb24-11" aria-hidden="true"></a><span class="st">  </span><span class="kw">stat_lineribbon</span>(<span class="dt">data =</span> p_amass_smass_males, <span class="kw">aes</span>(<span class="dt">x =</span> next_wtd12, <span class="dt">ydist =</span> rvar),</span>
<span id="cb24-12"><a href="#cb24-12" aria-hidden="true"></a>                  <span class="dt">.width =</span> <span class="kw">seq</span>(<span class="fl">0.5</span>, <span class="fl">0.95</span>, <span class="dt">length.out =</span> <span class="dv">20</span>), </span>
<span id="cb24-13"><a href="#cb24-13" aria-hidden="true"></a>                  <span class="dt">alpha =</span> <span class="fl">0.05</span>, <span class="dt">color =</span> <span class="st">&quot;black&quot;</span>, <span class="dt">fill =</span> <span class="st">&quot;grey67&quot;</span>) <span class="op">+</span></span>
<span id="cb24-14"><a href="#cb24-14" aria-hidden="true"></a><span class="st">  </span><span class="kw">labs</span>(</span>
<span id="cb24-15"><a href="#cb24-15" aria-hidden="true"></a>    <span class="dt">x =</span> <span class="st">&quot;Spring mass (kg)&quot;</span>, </span>
<span id="cb24-16"><a href="#cb24-16" aria-hidden="true"></a>    <span class="dt">y =</span> <span class="st">&quot;Autumn mass (kg)&quot;</span></span>
<span id="cb24-17"><a href="#cb24-17" aria-hidden="true"></a>  )  <span class="op">+</span></span>
<span id="cb24-18"><a href="#cb24-18" aria-hidden="true"></a><span class="st">  </span><span class="kw">theme_pubr</span>()</span>
<span id="cb24-19"><a href="#cb24-19" aria-hidden="true"></a></span>
<span id="cb24-20"><a href="#cb24-20" aria-hidden="true"></a>plot_amass_smass_males</span></code></pre></div>
<div class="cell-output-display">
<p><img src="kallan_case_study_files/figure-html/unnamed-chunk-16-1.png" width="672" /></p>
</div>
</div>
<h2 id="indirect-effect-of-snow-on-autumn-mass-population-density">Indirect effect of snow on autumn mass | population density</h2>
<p>This visualization is a bit tricky as the mediator (spring mass) does not interact with another variable for its effect on the outcome (autumn mass). However, the exposure (<em>snow</em> density) interacts with another exposure (<em>population</em> density) on the mediator (spring mass) and has no direct effect on the outcome (autumn mass).</p>
<div class="cell">
<div class="sourceCode" id="cb25"><pre class="sourceCode r cell-code"><code class="sourceCode r"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true"></a>p_smass_snow_males <span class="op">|</span><span class="er">&gt;</span><span class="st"> </span></span>
<span id="cb25-2"><a href="#cb25-2" aria-hidden="true"></a><span class="st">  </span><span class="kw">as_tibble</span>() <span class="op">|</span><span class="er">&gt;</span><span class="st"> </span></span>
<span id="cb25-3"><a href="#cb25-3" aria-hidden="true"></a><span class="st">  </span><span class="kw">select</span>(estimate, Pop_Density_Label, median_density_uns) <span class="op">|</span><span class="er">&gt;</span></span>
<span id="cb25-4"><a href="#cb25-4" aria-hidden="true"></a><span class="st">  </span><span class="kw">rename</span>(<span class="dt">next_wtd12 =</span> estimate) -&gt;<span class="st"> </span>spring_mass_pred_males</span>
<span id="cb25-5"><a href="#cb25-5" aria-hidden="true"></a></span>
<span id="cb25-6"><a href="#cb25-6" aria-hidden="true"></a><span class="co"># Custom prediction grid</span></span>
<span id="cb25-7"><a href="#cb25-7" aria-hidden="true"></a><span class="kw">datagrid</span>(<span class="dt">model =</span> Mass_loss_male_pop,</span>
<span id="cb25-8"><a href="#cb25-8" aria-hidden="true"></a>         <span class="dt">next_wtd12 =</span> spring_mass_pred_males<span class="op">$</span>next_wtd12) <span class="op">|</span><span class="er">&gt;</span></span>
<span id="cb25-9"><a href="#cb25-9" aria-hidden="true"></a><span class="st">  </span><span class="co"># need to add other columns separately as grid_type = &quot;dataframe&quot; argument throws an error     </span></span>
<span id="cb25-10"><a href="#cb25-10" aria-hidden="true"></a><span class="st">  </span><span class="kw">left_join</span>(spring_mass_pred_males <span class="op">|</span><span class="er">&gt;</span><span class="st"> </span><span class="kw">select</span>(next_wtd12, Pop_Density_Label, median_density_uns)) -&gt;<span class="st"> </span>f_snow_indirect_pred_grid_males</span></code></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Joining with `by = join_by(next_wtd12)`</code></pre>
</div>
<div class="sourceCode" id="cb27"><pre class="sourceCode r cell-code"><code class="sourceCode r"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true"></a>p_ind_snow_smass_males &lt;-<span class="st"> </span><span class="kw">predictions</span>(Mass_loss_male_pop,</span>
<span id="cb27-2"><a href="#cb27-2" aria-hidden="true"></a>                           <span class="dt">newdata =</span> f_snow_indirect_pred_grid_males,</span>
<span id="cb27-3"><a href="#cb27-3" aria-hidden="true"></a>                           <span class="dt">re_formula =</span> <span class="ot">NA</span>,              <span class="co"># Population-level predictions</span></span>
<span id="cb27-4"><a href="#cb27-4" aria-hidden="true"></a>                           <span class="dt">type =</span> <span class="st">&quot;response&quot;</span>,            <span class="co"># epred</span></span>
<span id="cb27-5"><a href="#cb27-5" aria-hidden="true"></a>                           <span class="dt">resp =</span> <span class="st">&quot;wtd114next&quot;</span>) <span class="op">|</span><span class="er">&gt;</span><span class="st">       </span><span class="co"># autumn mass</span></span>
<span id="cb27-6"><a href="#cb27-6" aria-hidden="true"></a><span class="st">                           </span><span class="kw">select</span>(estimate, next_wtd12, Pop_Density_Label, median_density_uns)</span>
<span id="cb27-7"><a href="#cb27-7" aria-hidden="true"></a></span>
<span id="cb27-8"><a href="#cb27-8" aria-hidden="true"></a>plot_ind_snow_males &lt;-<span class="st"> </span><span class="kw">ggplot</span>() <span class="op">+</span></span>
<span id="cb27-9"><a href="#cb27-9" aria-hidden="true"></a><span class="st">  </span><span class="kw">geom_line</span>(<span class="dt">data =</span> p_ind_snow_smass_males, <span class="kw">aes</span>(<span class="dt">x =</span> next_wtd12, <span class="dt">y =</span> estimate, <span class="dt">color =</span> median_density_uns, <span class="dt">linewidth =</span> median_density_uns), <span class="dt">lineend =</span> <span class="st">&quot;round&quot;</span>) <span class="op">+</span></span>
<span id="cb27-10"><a href="#cb27-10" aria-hidden="true"></a><span class="st">  </span><span class="kw">scale_color_gradientn</span>(<span class="dt">colours =</span> COLS, <span class="dt">name =</span> <span class="st">&quot;Med Snow Density&quot;</span>) <span class="op">+</span></span>
<span id="cb27-11"><a href="#cb27-11" aria-hidden="true"></a><span class="st">  </span><span class="kw">guides</span>(<span class="dt">linewidth =</span> <span class="st">&quot;none&quot;</span>) <span class="op">+</span></span>
<span id="cb27-12"><a href="#cb27-12" aria-hidden="true"></a><span class="st">  </span><span class="kw">facet_wrap</span>(<span class="op">~</span><span class="st"> </span>Pop_Density_Label) <span class="op">+</span></span>
<span id="cb27-13"><a href="#cb27-13" aria-hidden="true"></a><span class="st">  </span><span class="kw">theme</span>(<span class="dt">legend.direction =</span> <span class="st">&quot;horizontal&quot;</span>,</span>
<span id="cb27-14"><a href="#cb27-14" aria-hidden="true"></a>        <span class="dt">legend.position =</span> <span class="st">&quot;bottom&quot;</span>) <span class="op">+</span></span>
<span id="cb27-15"><a href="#cb27-15" aria-hidden="true"></a><span class="st">  </span><span class="kw">labs</span>(</span>
<span id="cb27-16"><a href="#cb27-16" aria-hidden="true"></a>    <span class="dt">x =</span> <span class="st">&quot;Spring mass (kg)&quot;</span>, </span>
<span id="cb27-17"><a href="#cb27-17" aria-hidden="true"></a>    <span class="dt">y =</span> <span class="st">&quot;Autumn mass (kg)&quot;</span></span>
<span id="cb27-18"><a href="#cb27-18" aria-hidden="true"></a>  )  <span class="op">+</span></span>
<span id="cb27-19"><a href="#cb27-19" aria-hidden="true"></a><span class="st">  </span><span class="kw">theme_pubr</span>()</span>
<span id="cb27-20"><a href="#cb27-20" aria-hidden="true"></a></span>
<span id="cb27-21"><a href="#cb27-21" aria-hidden="true"></a>plot_ind_snow_males</span></code></pre></div>
<div class="cell-output-display">
<p><img src="kallan_case_study_files/figure-html/unnamed-chunk-17-1.png" width="672" /></p>
</div>
</div>
<p>Now, we combine all plots</p>
<div class="cell">
<div class="sourceCode" id="cb28"><pre class="sourceCode r cell-code"><code class="sourceCode r"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true"></a>(plot_smass_snow_males <span class="op">+</span><span class="st"> </span>plot_amass_smass_males) <span class="op">/</span><span class="st"> </span>plot_ind_snow_males</span></code></pre></div>
<div class="cell-output-display">
<p><img src="kallan_case_study_files/figure-html/unnamed-chunk-18-1.png" width="672" /></p>
</div>
</div>
</body>
</html>
